Palette.Manager=function(t){if(!(t instanceof WebGLRenderingContext))throw new TypeError("Error: attempted to create Palette with illegal argument.");this.context=t,this.vertShaders={},this.fragShaders={},this.programs={},this.shaderFactory=new Palette.ShaderFactory(this)},Palette.Manager.prototype={addShader:function(t){this.shaderFactory.addShader(t)},draw:function(t,e,s,r,a){this.getProgram(t,e).draw(s,r,a)},getProgram:function(t,e){var s,r,a,i=this.getShaderName(t),o=this.getShaderName(e);return this.programs[i]=this.programs[i]||{},this.programs[i][o]=this.programs[i][o]||{},this.programs[i][o]instanceof Palette.Program||(s=t instanceof Palette.Shader?t:this.getShader(Palette.Shader.VS,i),r=e instanceof Palette.Shader?e:this.getShader(Palette.Shader.FS,o),this.programs[i][o]=new Palette.Program(this.context,s,r)),a=this.programs[i][o]},getShader:function(t,e){return t===Palette.Shader.VS?this.vertShaders[e]:this.fragShaders[e]},getShaderName:function(t){var e;return e=t instanceof Palette.Shader?t.name:t}},Palette.Manager.prototype.constructor=Palette.Manager;var Palette=Palette||{};Palette.Program=function(t,e,s){this.context=t,this.vs=e,this.fs=s,this.program=null,this.compiled=!1,this.attrs={vs:{access:{},store:{},send:{}},fs:{access:{},store:{},send:{}}},this.drawMode=Palette.Program.TRIANGLES,this.linkProgram(),this.prepareAttrStores()},Palette.Program.prototype={draw:function(t,e,s){this.context.useProgram(this.program),e||(e={}),e.vertexBuffer=t,this.generateSend(this.attrs.vs,e),this.generateSend(this.attrs.fs,s),this.passAttrstoProg(),this.context.drawArrays(this.drawMode,0,this.attrs.vs.send.vertexBuffer.length/this.attrs.vs.access.vertexBuffer.itemSize)},restoreDefaultConfig:function(t){for(var e,s,r=0;2>r;r++){if(r){if(!t&Palette.Program.FS_MODE)continue;s=this.fs,e=this.attrs.fs}else{if(!t&Palette.Program.VS_MODE)continue;s=this.vs,e=this.attrs.vs}for(var a=s.attrs.length-1;a>=0;a--){var i=s.attrs[a],o=i[0];"buffer"==i[1]||"vertexAttrib"==i[1]?e.store[o]=null:"vertexAttrib"!=i[1]&&(e.store[o]=i[2])}}},setConfig:function(t,e){for(var s,r,a=0;2>a;a++){if(a){if(!t&Palette.Program.FS_MODE)continue;r=this.fs,s=this.attrs.fs}else{if(!t&Palette.Program.VS_MODE)continue;r=this.vs,s=this.attrs.vs}for(var i in s.access){var o=s.store[i];void 0!=e[i]&&(o=e[i])}}},linkProgram:function(){return this.compiled?!1:(this.compiled=!0,this.program=this.context.createProgram(),this.context.attachShader(this.program,this.vs.shader),this.context.attachShader(this.program,this.fs.shader),this.context.linkProgram(this.program),!0)},prepareAttrStores:function(){this.context.useProgram(this.program);for(var t,e,s=0;2>s;s++){s?(t=this.fs,e=this.attrs.fs):(t=this.vs,e=this.attrs.vs);for(var r=t.attrs.length-1;r>=0;r--){var a=t.attrs[r],i=a[0];e.access[i]=e.access[i]||{};var o=e.access[i];o.setFunction=Palette.Program.fetchSetter(this.context,a[1]),"vertexAttrib"==a[1]?(o.pointer=this.context.getAttribLocation(this.program,a[0]),this.context.enableVertexAttribArray(o.pointer),o.bufferName=a[2]):"buffer"==a[1]?(o.pointer=this.context.createBuffer(),o.itemSize=a[2]):o.pointer=this.context.getUniformLocation(this.program,a[0]),o.type=a[1]}}this.restoreDefaultConfig(Palette.Program.BOTH_MODE)},passAttrstoProg:function(){for(var t,e=0;2>e;e++){t=e?this.attrs.fs:this.attrs.vs;for(var s in t.access){var r=t.send[s],a=t.access[s];if("mat"==a.type.substr(0,3))a.setFunction(a.pointer,this.context.FALSE,r);else if("vertexAttrib"==a.type){var i=this.attrs.vs.access[a.bufferName];a.setFunction(a,i)}else"buffer"==a.type?a.setFunction(a,r):a.setFunction(a.pointer,r)}}},setDrawMode:function(t){this.drawMode=t},generateSend:function(t,e){var s;for(name in t.access)s=e[name]?e[name]:t.store[name],t.send[name]=s}},Palette.Program.fetchSetter=function(t,e){var s=function(t){return function(e,s){t(e,s[0])}},r=function(t){return function(e,s){t(e,s[0],s[1])}},a=function(t){return function(e,s){t(e,s[0],s[1],s[2])}},i=function(t){return function(e,s){t(e,s[0],s[1],s[2],s[3])}};switch(e){case"float":return s(t.uniform1f.bind(t));case"float[]":return t.uniform1fv.bind(t);case"int":return s(t.uniform1i.bind(t));case"int[]":return t.uniform1iv.bind(t);case"vec2":return r(t.uniform2f.bind(t));case"vec2[]":return t.uniform2fv.bind(t);case"ivec2":return r(t.uniform2i.bind(t));case"ivec2[]":return t.uniform2iv.bind(t);case"vec3":return a(t.uniform3f.bind(t));case"vec3[]":return t.uniform3fv.bind(t);case"ivec3":return a(t.uniform3i.bind(t));case"ivec3[]":return t.uniform3iv.bind(t);case"vec4":return i(t.uniform4f.bind(t));case"vec4[]":return t.uniform4fv.bind(t);case"ivec4":return i(t.uniform4i.bind(t));case"ivec4[]":return t.uniform4iv.bind(t);case"mat2":return t.uniformMatrix2fv.bind(t);case"mat3":return t.uniformMatrix3fv.bind(t);case"mat4":return t.uniformMatrix4fv.bind(t);case"texture":return alert("You're on your own, kid."),null;case"vertexAttrib":var o=function(e,s){t.bindBuffer(t.ARRAY_BUFFER,s.pointer),t.vertexAttribPointer(e.pointer,s.itemSize,t.FLOAT,!1,0,0)};return o.bind(t);case"buffer":var o=function(e,s){t.bindBuffer(t.ARRAY_BUFFER,e.pointer),t.bufferData(t.ARRAY_BUFFER,s,t.DYNAMIC_DRAW)};return o.bind(t);default:return alert("Not gonna lie - you really messed up. I can't pass "+e+" onto the shader."),null}},Palette.Program.NONE_MODE=0,Palette.Program.VS_MODE=1,Palette.Program.FS_MODE=2,Palette.Program.BOTH_MODE=3,Palette.Program.POINTS=0,Palette.Program.LINES=1,Palette.Program.LINE_LOOP=2,Palette.Program.LINE_STRIP=3,Palette.Program.TRIANGLES=4,Palette.Program.TRIANGLE_STRIP=5,Palette.Program.TRIANGLE_FAN=6,Palette.Program.prototype.constructor=Palette.Program,Palette.Shader=function(t,e,s,r,a){this.name=e,this.type=s,this.context=t,this.attrs=a,this.shader=null,this.compiled=!1,this.bakeShader(r)},Palette.Shader.prototype={bakeShader:function(t){if(this.compiled)return null;switch(this.compiled=!0,this.type){case Palette.Shader.VS:this.shader=this.context.createShader(this.context.VERTEX_SHADER);break;case Palette.Shader.FS:this.shader=this.context.createShader(this.context.FRAGMENT_SHADER);break;default:return!1}return this.context.shaderSource(this.shader,t),this.context.compileShader(this.shader),this.context.getShaderParameter(this.shader,this.context.COMPILE_STATUS)?!0:(alert("An error occurred compiling the shaders: "+this.context.getShaderInfoLog(this.shader)),!1)}},Palette.Shader.VS=0,Palette.Shader.FS=1,Palette.Shader.LIST=2,Palette.Shader.prototype.constructor=Palette.Shader,Palette.ShaderFactory=function(t){that=this,this.manager=t,this.downloadInProgress=!1},Palette.ShaderFactory.prototype={addShader:function(t){var e,s;switch(this.establishType(t)){case Palette.ShaderFactory.SOURCE_OBJECT:e=t;case Palette.ShaderFactory.JSON:e=e||JSON.parse(t),s=this.createShaderObject(e);break;case Palette.ShaderFactory.SHADER_OBJECT:s=t;break;case Palette.ShaderFactory.URL:this.downloadFromURL(t);break;default:throw new Error("Not a valid type of shader.")}s&&this.registerShader(s)},createShaderObject:function(t){switch(t.type){case Palette.Shader.VS:case Palette.Shader.FS:return new Palette.Shader(this.manager.context,t.name,t.type,t.src,t.attrs);case Palette.Shader.LIST:for(var e=t.content.length-1;e>=0;e--)this.addShader(t.content[e]);break;default:throw new Error("Tried to create an illegal class of shader.")}},downloadFromURL:function(t){var e=new XMLHttpRequest;e.open("GET",t,!0),e.onload=function(){console.log(that),that.addShader(e.response),that.downloadInProgress=!1},that.downloadInProgress=!0,e.send()},establishType:function(t){var e=-1;return t instanceof Palette.Shader?e=Palette.ShaderFactory.SHADER_OBJECT:void 0!=t.type&&void 0!=t.name&&(t.content||t.src)?e=Palette.ShaderFactory.SOURCE_OBJECT:this.isJSON(t)?e=Palette.ShaderFactory.JSON:this.isString(t)&&(e=Palette.ShaderFactory.URL),e},isJSON:function(t){try{return JSON.parse(t),!0}catch(e){return!1}},isString:function(t){return"string"==typeof t||t instanceof String},registerShader:function(t){switch(t.type){case Palette.Shader.VS:this.manager.vertShaders[t.name]=this.manager.vertShaders[t.name]||t;break;case Palette.Shader.FS:this.manager.fragShaders[t.name]=this.manager.fragShaders[t.name]||t;break;default:throw new Error("Tried to register an illegal class of shader.")}}},Palette.ShaderFactory.SOURCE_OBJECT=0,Palette.ShaderFactory.JSON=1,Palette.ShaderFactory.URL=2,Palette.ShaderFactory.SHADER_OBJECT=3,Palette.ShaderFactory.prototype.constructor=Palette.ShaderFactory;var MVM=function(){this.opCodes={STOREG:0,LOADG:1,STOREL:2,LOADL:3,LOADC:4,IADD:5,ISUB:6,IMUL:7,IDIV:8,FADD:9,FSUB:10,FMUL:11,FDIV:12,NCMPEQ:13,NCMPLT:14,NCMPGT:15,JUMP:16,JUMPT:17,JUMPF:18,CALL:19,RETURN:20},this.codeStore=[this.opCodes.LOADC,16,this.opCodes.STOREG,0,this.opCodes.LOADC,0,this.opCodes.STOREL,0,this.opCodes.LOADC,2,this.opCodes.STOREL,1,this.opCodes.LOADL,0,this.opCodes.LOADG,0,this.opCodes.NCMPLT,this.opCodes.JUMPF,35,this.opCodes.LOADL,1,this.opCodes.LOADC,2,this.opCodes.IMUL,this.opCodes.STOREL,1,this.opCodes.LOADL,0,this.opCodes.LOADC,1,this.opCodes.IADD,this.opCodes.STOREL,0,this.opCodes.JUMP,12,this.opCodes.LOADL,1,999],this.cp=0,this.cl=38,this.dataStore=[],this.sp=0,this.fp=0,this.LO=2,this.DLA=0,this.RA=1,this.globalStore=[],this.debugMode=0,this.interpret=function(){for(var t=0,e=this.opCodes;this.cp<this.cl;){t++;var s=this.codeStore[this.cp];switch(this.cp++,s){case e.STOREG:var r=this.codeStore[this.cp];this.cp++,this.sp--;var a=this.dataStore[this.sp];this.globalStore[r]=a,this.debugMode&&console.log("STOREG: "+a+" "+r);break;case e.LOADG:var r=this.codeStore[this.cp];this.cp++,this.dataStore[this.sp]=this.globalStore[r],this.sp++,this.debugMode&&console.log("LOADG: "+a+" "+r);break;case e.STOREL:var i=this.codeStore[this.cp];this.cp++,this.sp--,this.dataStore[this.fp+i]=this.dataStore[this.sp],this.sp++,this.debugMode&&console.log("STOREL: "+this.dataStore[this.sp-1]+" "+i);break;case e.LOADL:var i=this.codeStore[this.cp];this.cp++,this.dataStore[this.sp]=this.dataStore[this.fp+i],this.sp++,this.debugMode&&console.log("LOADL: "+this.dataStore[this.sp-1]+" "+i);break;case e.LOADC:var o=this.codeStore[this.cp];this.cp++,this.dataStore[this.sp]=o,this.sp++,this.debugMode&&console.log("LOADC: "+o);break;case e.IADD:this.sp--;var a=Math.floor(this.dataStore[this.sp]);this.sp--;var h=Math.floor(this.dataStore[this.sp]),n=h+a;this.dataStore[this.sp]=n,this.sp++,this.debugMode&&console.log("IADD: "+h+" + "+a+" = "+n);break;case e.ISUB:this.sp--;var a=Math.floor(this.dataStore[this.sp]);this.sp--;var h=Math.floor(this.dataStore[this.sp]),n=h-a;this.dataStore[this.sp]=n,this.sp++,this.debugMode&&console.log("ISUB: "+h+" - "+a+" = "+n);break;case e.IMUL:this.sp--;var a=Math.floor(this.dataStore[this.sp]);this.sp--;var h=Math.floor(this.dataStore[this.sp]),n=h*a;this.dataStore[this.sp]=n,this.sp++,this.debugMode&&console.log("IMUL: "+h+" * "+a+" = "+n);break;case e.IDIV:this.sp--;var a=Math.floor(this.dataStore[this.sp]);this.sp--;var h=Math.floor(this.dataStore[this.sp]),n=Math.floor(h/a);this.dataStore[this.sp]=n,this.sp++,this.debugMode&&console.log("IDIV: "+h+" / "+a+" = "+n);break;case e.FADD:this.sp--;var a=this.dataStore[this.sp];this.sp--;var h=this.dataStore[this.sp],n=h+a;this.dataStore[this.sp]=n,this.sp++,this.debugMode&&console.log("FADD: "+h+" + "+a+" = "+n);break;case e.FSUB:this.sp--;var a=this.dataStore[this.sp];this.sp--;var h=this.dataStore[this.sp];this.dataStore[this.sp]=h-a,this.sp++,this.debugMode&&console.log("FSUB: "+h+" - "+a+" = "+n);break;case e.FMUL:this.sp--;var a=this.dataStore[this.sp];this.sp--;var h=this.dataStore[this.sp],n=h*a;this.dataStore[this.sp]=n,this.sp++,this.debugMode&&console.log("FMUL: "+h+" * "+a+" = "+n);break;case e.FDIV:this.sp--;var a=this.dataStore[this.sp];this.sp--;var h=this.dataStore[this.sp],n=h/a;this.dataStore[this.sp]=n,this.sp++,this.debugMode&&console.log("FMUL: "+h+" / "+a+" = "+n);break;case e.NCMPEQ:this.sp--;var a=this.dataStore[this.sp];this.sp--;var h=this.dataStore[this.sp],n=h==a?1:0;this.dataStore[this.sp]=n,this.sp++,this.debugMode&&console.log("NCMPEQ: "+h+" == "+a+" = "+n);break;case e.NCMPLT:this.sp--;var a=this.dataStore[this.sp];this.sp--;var h=this.dataStore[this.sp],n=a>h?1:0;this.dataStore[this.sp]=n,this.sp++,this.debugMode&&console.log("NCMPLT: "+h+" < "+a+" = "+n);break;case e.NCMPGT:this.sp--;var a=this.dataStore[this.sp];this.sp--;var h=this.dataStore[this.sp],n=h>a?1:0;this.dataStore[this.sp]=n,this.sp++,this.debugMode&&console.log("NCMPLT: "+h+" > "+a+" = "+n);break;case e.JUMP:var r=this.codeStore[this.cp];this.cp=r,this.debugMode&&console.log("JUMP: "+r);break;case e.JUMPT:var r=this.codeStore[this.cp];this.sp--;var a=this.dataStore[this.sp];n=1==a,n?this.cp=this.codeStore[this.cp]:this.cp++,this.debugMode&&console.log("JUMPT: "+a+" "+n);break;case e.JUMPF:var r=this.codeStore[this.cp];this.sp--;var a=this.dataStore[this.sp],n=0==a;this.debugMode&&console.log("JUMPF: "+a+" "+n),n?this.cp=this.codeStore[this.cp]:this.cp++;break;case e.CALL:var r=this.codeStore[this.cp];cp++;var c=this.codeStore[this.cp];cp++;for(var d=this.cp,p=this.fp,S=[],a=0;c>a;)sp--,S[a]=this.dataStore[sp],a++;for(this.fp=this.sp,this.dataStore[sp]=p,this.sp++,this.dataStore[sp]=d,this.sp++;a>=0;)a--,this.dataStore[this.sp]=arg[a],sp++;break;case e.RETURN:var l,f=this.codeStore[this.cp];f&&(l=this.dataStore[this.sp-1]);var d=this.dataStore[this.fp+this.RA];this.cp=d,this.sp=this.fp,this.fp=this.dataStore[this.fp+this.DLA],this.dataStore[this.sp]=l,this.sp++;case 999:this.debugMode&&console.log(this.dataStore[this.sp-1])}if(t++,t>1e5){console.log("INF LOOP");break}}}};