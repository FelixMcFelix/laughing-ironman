Palette.Manager=function(t){if(!(t instanceof WebGLRenderingContext))throw new TypeError("Error: attempted to create Palette with illegal argument.");this.context=t,this.vertShaders={},this.fragShaders={},this.programs={},this.shaderFactory=new Palette.ShaderFactory(this)},Palette.Manager.prototype={addShader:function(t){this.shaderFactory.addShader(t)},draw:function(t,e,r,a,o){this.getProgram(t,e).draw(r,a,o)},getProgram:function(t,e){var r,a,o,n=this.getShaderName(t),i=this.getShaderName(e);return this.programs[n]=this.programs[n]||{},this.programs[n][i]=this.programs[n][i]||{},this.programs[n][i]instanceof Palette.Program||(r=t instanceof Palette.Shader?t:this.getShader(Palette.Shader.VS,n),a=e instanceof Palette.Shader?e:this.getShader(Palette.Shader.FS,i),this.programs[n][i]=new Palette.Program(this.context,r,a)),o=this.programs[n][i]},getShader:function(t,e){return t===Palette.Shader.VS?this.vertShaders[e]:this.fragShaders[e]},getShaderName:function(t){var e;return e=t instanceof Palette.Shader?t.name:t}},Palette.Manager.prototype.constructor=Palette.Manager;var Palette=Palette||{};Palette.Program=function(t,e,r){this.context=t,this.vs=e,this.fs=r,this.program=null,this.compiled=!1,this.attrStore={vs:{},fs:{}},this.vtxBuffer=t.createBuffer(),this.linkProgram(),this.prepareAttrStores()},Palette.Program.prototype={draw:function(t,e,r){this.context.useProgram(this.program);var a=(e?Palette.Program.VS_MODE:0)|(r?Palette.Program.FS_MODE:0);this.passAttrstoProg(a),this.context.bindBuffer(this.context.ARRAY_BUFFER,this.vtxBuffer),this.context.bufferData(this.context.ARRAY_BUFFER,new Float32Array(t),this.context.DYNAMIC_DRAW),this.context.drawArrays(this.context.TRIANGLES,0,t.length)},restoreDefaultConfig:function(){for(var t=0;2>t;t++);},setConfig:function(){},linkProgram:function(){return this.compiled?!1:(this.compiled=!0,this.program=this.context.createProgram(),this.context.attachShader(this.program,this.vs.shader),this.context.attachShader(this.program,this.fs.shader),this.context.linkProgram(this.program),!0)},prepareAttrStores:function(){this.context.useProgram(this.program);for(var t,e,r=0;2>r;r++){r?(t=this.fs,e=this.attrStore.fs):(t=this.vs,e=this.attrStore.vs);for(var a=t.attrs.length-1;a>=0;a--){var o=t.attrs[a],n=e[o[0]]||{};n.setFunction=Palette.Program.fetchSetter(this.context,o[1]),"vertexAttrib"!=o[1]?(n.pointer=this.context.getUniformLocation(this.program,o[0]),n.value=o[2]):(n.pointer=this.context.getAttribLocation(this.program,o[0]),alert("I have no idea what do with values here."))}}},passAttrstoProg:function(t){for(var e,r="value",a=0;2>a;a++){a?(e=this.attrStore.fs,r=t===Palette.Program.FS_MODE||t===Palette.Program.BOTH_MODE?"tempValue":"value"):(e=this.attrStore.vs,(t===Palette.Program.VS_MODE||t===Palette.Program.BOTH_MODE)&&(r="tempValue"));for(var o in e){var n=e[o],i=n[r]||n.value;"mat"==n.type.substr(0,3)?n.setFunction(n.pointer,this.context.FALSE,i):(n.type=vertexAttrib)||n.setFunction(n.pointer,i)}}}},Palette.Program.fetchSetter=function(t,e){switch(e){case"float":return t.uniform1f.bind(t);case"float[]":return t.uniform1fv.bind(t);case"int":return t.uniform1i.bind(t);case"int[]":return t.uniform1iv.bind(t);case"vec2":return t.uniform2f.bind(t);case"vec2[]":return t.uniform2fv.bind(t);case"ivec2":return t.uniform2i.bind(t);case"ivec2[]":return t.uniform2iv.bind(t);case"vec3":return t.uniform3f.bind(t);case"vec3[]":return t.uniform3fv.bind(t);case"ivec3":return t.uniform3i.bind(t);case"ivec3[]":return t.uniform3iv.bind(t);case"vec4":return t.uniform4f.bind(t);case"vec4[]":return t.uniform4fv.bind(t);case"ivec4":return t.uniform4i.bind(t);case"ivec4[]":return t.uniform4iv.bind(t);case"mat2":return t.uniformMatrix2fv.bind(t);case"mat3":return t.uniformMatrix3fv.bind(t);case"mat4":return t.uniformMatrix4fv.bind(t);case"texture":return alert("You're on your own, kid."),null;case"vertexAttrib":return alert("You're still on your own, kid."),null;default:return alert("Not gonna lie - you really messed up. I can't pass "+e+" onto the shader."),null}},Palette.Program.NONE_MODE=0,Palette.Program.VS_MODE=1,Palette.Program.FS_MODE=2,Palette.Program.BOTH_MODE=3,Palette.Program.prototype.constructor=Palette.Program,Palette.Shader=function(t,e,r,a,o){this.name=e,this.type=r,this.context=t,this.attrs=o,this.shader=null,this.compiled=!1,this.bakeShader(a)},Palette.Shader.prototype={bakeShader:function(t){if(this.compiled)return null;switch(this.compiled=!0,this.type){case Palette.Shader.VS:this.shader=this.context.createShader(this.context.VERTEX_SHADER);break;case Palette.Shader.FS:this.shader=this.context.createShader(this.context.FRAGMENT_SHADER);break;default:return!1}return this.context.shaderSource(this.shader,t),this.context.compileShader(this.shader),this.context.getShaderParameter(this.shader,this.context.COMPILE_STATUS)?!0:(alert("An error occurred compiling the shaders: "+this.context.getShaderInfoLog(this.shader)),!1)}},Palette.Shader.VS=0,Palette.Shader.FS=1,Palette.Shader.LIST=2,Palette.Shader.prototype.constructor=Palette.Shader,Palette.ShaderFactory=function(t){that=this,this.manager=t,this.downloadInProgress=!1},Palette.ShaderFactory.prototype={addShader:function(t){var e,r;switch(this.establishType(t)){case Palette.ShaderFactory.SOURCE_OBJECT:e=t;case Palette.ShaderFactory.JSON:e=e||JSON.parse(t),r=this.createShaderObject(e);break;case Palette.ShaderFactory.SHADER_OBJECT:r=t;break;case Palette.ShaderFactory.URL:this.downloadFromURL(t);break;default:throw new Error("Not a valid type of shader.")}r&&this.registerShader(r)},createShaderObject:function(t){switch(t.type){case Palette.Shader.VS:case Palette.Shader.FS:return new Palette.Shader(this.manager.context,t.name,t.type,t.src,t.attrs);case Palette.Shader.LIST:for(var e=t.content.length-1;e>=0;e--)this.addShader(t.content[e]);break;default:throw new Error("Tried to create an illegal class of shader.")}},downloadFromURL:function(t){var e=new XMLHttpRequest;e.open("GET",t,!0),e.onload=function(){console.log(that),that.addShader(e.response),that.downloadInProgress=!1},that.downloadInProgress=!0,e.send()},establishType:function(t){var e=-1;return t instanceof Palette.Shader?e=Palette.ShaderFactory.SHADER_OBJECT:void 0!=t.type&&void 0!=t.name&&(t.content||t.src)?e=Palette.ShaderFactory.SOURCE_OBJECT:this.isJSON(t)?e=Palette.ShaderFactory.JSON:this.isString(t)&&(e=Palette.ShaderFactory.URL),e},isJSON:function(t){try{return JSON.parse(t),!0}catch(e){return!1}},isString:function(t){return"string"==typeof t||t instanceof String},registerShader:function(t){switch(t.type){case Palette.Shader.VS:this.manager.vertShaders[t.name]=this.manager.vertShaders[t.name]||t;break;case Palette.Shader.FS:this.manager.fragShaders[t.name]=this.manager.fragShaders[t.name]||t;break;default:throw new Error("Tried to register an illegal class of shader.")}}},Palette.ShaderFactory.SOURCE_OBJECT=0,Palette.ShaderFactory.JSON=1,Palette.ShaderFactory.URL=2,Palette.ShaderFactory.SHADER_OBJECT=3,Palette.ShaderFactory.prototype.constructor=Palette.ShaderFactory;