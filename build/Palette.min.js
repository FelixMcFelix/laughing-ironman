var Palette=Palette||{};Palette.Manager=function(t){if(!(t instanceof WebGLRenderingContext))throw new TypeError("Error: attempted to create Palette with illegal argument.");this.context=t,this.vertShaders={},this.fragShaders={},this.programs={},this.shaderFactory=new Palette.ShaderFactory(this)},Palette.Manager.prototype={addShader:function(t){this.shaderFactory.addShader(t)},draw:function(t,e,r,a,s){this.getProgram(t,e).draw(r,a,s)},getProgram:function(t,e){var r,a,s,n=this.getShaderName(t),i=this.getShaderName(e);return this.programs[n]=this.programs[n]||{},this.programs[n][i]=this.programs[n][i]||{},this.programs[n][i]instanceof Palette.Program||(r=t instanceof Palette.Shader?t:this.getShader(Palette.Shader.VS,n),a=e instanceof Palette.Shader?e:this.getShader(Palette.Shader.FS,i),this.programs[n][i]=new Palette.Program(this.context,r,a)),s=this.programs[n][i]},getShader:function(t,e){return t===Palette.Shader.VS?this.vertShaders[e]:this.fragShaders[e]},getShaderName:function(t){var e;return e=t instanceof Palette.Shader?t.name:t}},Palette.Manager.prototype.constructor=Palette.Manager,Palette.Program=function(t,e,r){this.context=t,this.vs=e,this.fs=r,this.program=null,this.compiled=!1,this.attrs={vs:{access:{},store:{},send:{}},fs:{access:{},store:{},send:{}}},this.drawMode=Palette.Program.TRIANGLES,this.linkProgram(),this.prepareAttrStores()},Palette.Program.prototype={draw:function(t,e,r){this.context.useProgram(this.program),e||(e={}),e.vertexBuffer=t,this.generateSend(this.attrs.vs,e),this.generateSend(this.attrs.fs,r),this.passAttrstoProg(),this.context.drawArrays(this.drawMode,0,this.attrs.vs.send.vertexBuffer.length/this.attrs.vs.access.vertexBuffer.itemSize)},restoreDefaultConfig:function(t){for(var e,r,a=0;2>a;a++){if(a){if(!t&Palette.Program.FS_MODE)continue;r=this.fs,e=this.attrs.fs}else{if(!t&Palette.Program.VS_MODE)continue;r=this.vs,e=this.attrs.vs}for(var s=r.attrs.length-1;s>=0;s--){var n=r.attrs[s],i=n[0];"buffer"==n[1]||"vertexAttrib"==n[1]?e.store[i]=null:"vertexAttrib"!=n[1]&&(e.store[i]=n[2])}}},setConfig:function(t,e){for(var r,a,s=0;2>s;s++){if(s){if(!t&Palette.Program.FS_MODE)continue;a=this.fs,r=this.attrs.fs}else{if(!t&Palette.Program.VS_MODE)continue;a=this.vs,r=this.attrs.vs}for(var n in r.access){var i=r.store[n];void 0!=e[n]&&(i=e[n])}}},linkProgram:function(){return this.compiled?!1:(this.compiled=!0,this.program=this.context.createProgram(),this.context.attachShader(this.program,this.vs.shader),this.context.attachShader(this.program,this.fs.shader),this.context.linkProgram(this.program),!0)},prepareAttrStores:function(){this.context.useProgram(this.program);for(var t,e,r=0;2>r;r++){r?(t=this.fs,e=this.attrs.fs):(t=this.vs,e=this.attrs.vs);for(var a=t.attrs.length-1;a>=0;a--){var s=t.attrs[a],n=s[0];e.access[n]=e.access[n]||{};var i=e.access[n];i.setFunction=Palette.Program.fetchSetter(this.context,s[1]),"vertexAttrib"==s[1]?(i.pointer=this.context.getAttribLocation(this.program,s[0]),this.context.enableVertexAttribArray(i.pointer),i.bufferName=s[2]):"buffer"==s[1]?(i.pointer=this.context.createBuffer(),i.itemSize=s[2]):i.pointer=this.context.getUniformLocation(this.program,s[0]),i.type=s[1]}}this.restoreDefaultConfig(Palette.Program.BOTH_MODE)},passAttrstoProg:function(){for(var t,e=0;2>e;e++){t=e?this.attrs.fs:this.attrs.vs;for(var r in t.access){var a=t.send[r],s=t.access[r];if("mat"==s.type.substr(0,3))s.setFunction(s.pointer,this.context.FALSE,a);else if("vertexAttrib"==s.type){var n=this.attrs.vs.access[s.bufferName];s.setFunction(s,n)}else"buffer"==s.type?s.setFunction(s,a):s.setFunction(s.pointer,a)}}},setDrawMode:function(t){this.drawMode=t},generateSend:function(t,e){var r;for(name in t.access)r=e[name]?e[name]:t.store[name],t.send[name]=r}},Palette.Program.fetchSetter=function(t,e){var r=function(t){return function(e,r){t(e,r[0])}},a=function(t){return function(e,r){t(e,r[0],r[1])}},s=function(t){return function(e,r){t(e,r[0],r[1],r[2])}},n=function(t){return function(e,r){t(e,r[0],r[1],r[2],r[3])}};switch(e){case"float":return r(t.uniform1f.bind(t));case"float[]":return t.uniform1fv.bind(t);case"int":return r(t.uniform1i.bind(t));case"int[]":return t.uniform1iv.bind(t);case"vec2":return a(t.uniform2f.bind(t));case"vec2[]":return t.uniform2fv.bind(t);case"ivec2":return a(t.uniform2i.bind(t));case"ivec2[]":return t.uniform2iv.bind(t);case"vec3":return s(t.uniform3f.bind(t));case"vec3[]":return t.uniform3fv.bind(t);case"ivec3":return s(t.uniform3i.bind(t));case"ivec3[]":return t.uniform3iv.bind(t);case"vec4":return n(t.uniform4f.bind(t));case"vec4[]":return t.uniform4fv.bind(t);case"ivec4":return n(t.uniform4i.bind(t));case"ivec4[]":return t.uniform4iv.bind(t);case"mat2":return t.uniformMatrix2fv.bind(t);case"mat3":return t.uniformMatrix3fv.bind(t);case"mat4":return t.uniformMatrix4fv.bind(t);case"texture":return alert("You're on your own, kid."),null;case"vertexAttrib":var i=function(e,r){t.bindBuffer(t.ARRAY_BUFFER,r.pointer),t.vertexAttribPointer(e.pointer,r.itemSize,t.FLOAT,!1,0,0)};return i.bind(t);case"buffer":var i=function(e,r){t.bindBuffer(t.ARRAY_BUFFER,e.pointer),t.bufferData(t.ARRAY_BUFFER,r,t.DYNAMIC_DRAW)};return i.bind(t);default:return alert("Not gonna lie - you really messed up. I can't pass "+e+" onto the shader."),null}},Palette.Program.NONE_MODE=0,Palette.Program.VS_MODE=1,Palette.Program.FS_MODE=2,Palette.Program.BOTH_MODE=3,Palette.Program.POINTS=0,Palette.Program.LINES=1,Palette.Program.LINE_LOOP=2,Palette.Program.LINE_STRIP=3,Palette.Program.TRIANGLES=4,Palette.Program.TRIANGLE_STRIP=5,Palette.Program.TRIANGLE_FAN=6,Palette.Program.prototype.constructor=Palette.Program,Palette.Shader=function(t,e,r,a,s){this.name=e,this.type=r,this.context=t,this.attrs=s,this.shader=null,this.compiled=!1,this.bakeShader(a)},Palette.Shader.prototype={bakeShader:function(t){if(this.compiled)return null;switch(this.compiled=!0,this.type){case Palette.Shader.VS:this.shader=this.context.createShader(this.context.VERTEX_SHADER);break;case Palette.Shader.FS:this.shader=this.context.createShader(this.context.FRAGMENT_SHADER);break;default:return!1}return this.context.shaderSource(this.shader,t),this.context.compileShader(this.shader),this.context.getShaderParameter(this.shader,this.context.COMPILE_STATUS)?!0:(alert("An error occurred compiling the shaders: "+this.context.getShaderInfoLog(this.shader)),!1)}},Palette.Shader.VS=0,Palette.Shader.FS=1,Palette.Shader.LIST=2,Palette.Shader.prototype.constructor=Palette.Shader,Palette.ShaderFactory=function(t){that=this,this.manager=t,this.downloadInProgress=!1},Palette.ShaderFactory.prototype={addShader:function(t){var e,r;switch(this.establishType(t)){case Palette.ShaderFactory.SOURCE_OBJECT:e=t;case Palette.ShaderFactory.JSON:e=e||JSON.parse(t),r=this.createShaderObject(e);break;case Palette.ShaderFactory.SHADER_OBJECT:r=t;break;case Palette.ShaderFactory.URL:this.downloadFromURL(t);break;default:throw new Error("Not a valid type of shader.")}r&&this.registerShader(r)},createShaderObject:function(t){switch(t.type){case Palette.Shader.VS:case Palette.Shader.FS:return new Palette.Shader(this.manager.context,t.name,t.type,t.src,t.attrs);case Palette.Shader.LIST:for(var e=t.content.length-1;e>=0;e--)this.addShader(t.content[e]);break;default:throw new Error("Tried to create an illegal class of shader.")}},downloadFromURL:function(t){var e=new XMLHttpRequest;e.open("GET",t,!0),e.onload=function(){console.log(that),that.addShader(e.response),that.downloadInProgress=!1},that.downloadInProgress=!0,e.send()},establishType:function(t){var e=-1;return t instanceof Palette.Shader?e=Palette.ShaderFactory.SHADER_OBJECT:void 0!=t.type&&void 0!=t.name&&(t.content||t.src)?e=Palette.ShaderFactory.SOURCE_OBJECT:this.isJSON(t)?e=Palette.ShaderFactory.JSON:this.isString(t)&&(e=Palette.ShaderFactory.URL),e},isJSON:function(t){try{return JSON.parse(t),!0}catch(e){return!1}},isString:function(t){return"string"==typeof t||t instanceof String},registerShader:function(t){switch(t.type){case Palette.Shader.VS:this.manager.vertShaders[t.name]=this.manager.vertShaders[t.name]||t;break;case Palette.Shader.FS:this.manager.fragShaders[t.name]=this.manager.fragShaders[t.name]||t;break;default:throw new Error("Tried to register an illegal class of shader.")}}},Palette.ShaderFactory.SOURCE_OBJECT=0,Palette.ShaderFactory.JSON=1,Palette.ShaderFactory.URL=2,Palette.ShaderFactory.SHADER_OBJECT=3,Palette.ShaderFactory.prototype.constructor=Palette.ShaderFactory;