function earcut(e,t){var r=filterPoints(linkedList(e[0],!0)),n=t?{vertices:[],indices:[]}:[];if(!r)return n;var s,a,o,i,c,h,l,u,d,p=80;for(d=0;p>=0&&d<e.length;d++)p-=e[d].length;if(0>p){s=r.next,a=i=s.p[0],o=c=s.p[1];do h=s.p[0],l=s.p[1],a>h&&(a=h),o>l&&(o=l),h>i&&(i=h),l>c&&(c=l),s=s.next;while(s!==r);u=Math.max(i-a,c-o)}return e.length>1&&(r=eliminateHoles(e,r)),earcutLinked(r,n,a,o,u),n}function linkedList(e,t){var r,n,s,a,o,i=0,c=e.length;for(r=0,n=c-1;c>r;n=r++)s=e[r],a=e[n],i+=(a[0]-s[0])*(s[1]+a[1]);if(t===i>0)for(r=0;c>r;r++)o=insertNode(e[r],o);else for(r=c-1;r>=0;r--)o=insertNode(e[r],o);return o}function filterPoints(e,t){t||(t=e);var r,n=e;do if(r=!1,equals(n.p,n.next.p)||0===orient(n.prev.p,n.p,n.next.p)){if(n.prev.next=n.next,n.next.prev=n.prev,n.prevZ&&(n.prevZ.nextZ=n.nextZ),n.nextZ&&(n.nextZ.prevZ=n.prevZ),n=t=n.prev,n===n.next)return null;r=!0}else n=n.next;while(r||n!==t);return t}function earcutLinked(e,t,r,n,s,a){if(e){var o=void 0!==t.vertices;a||void 0===r||indexCurve(e,r,n,s);for(var i,c,h=e;e.prev!==e.next;)if(i=e.prev,c=e.next,isEar(e,r,n,s))o?(addIndexedVertex(t,i),addIndexedVertex(t,e),addIndexedVertex(t,c)):(t.push(i.p),t.push(e.p),t.push(c.p)),c.prev=i,i.next=c,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ),e=c.next,h=c.next;else if(e=c,e===h){a?1===a?(e=cureLocalIntersections(e,t),earcutLinked(e,t,r,n,s,2)):2===a&&splitEarcut(e,t,r,n,s):earcutLinked(filterPoints(e),t,r,n,s,1);break}}}function addIndexedVertex(e,t){t.source&&(t=t.source);var r=t.index;if(null===r){var n=t.p.length,s=e.vertices;t.index=r=s.length/n;for(var a=0;n>a;a++)s.push(t.p[a])}e.indices.push(r)}function isEar(e,t,r,n){var s=e.prev.p,a=e.p,o=e.next.p,i=s[0],c=a[0],h=o[0],l=s[1],u=a[1],d=o[1],p=i*u-l*c,S=i*d-l*h,k=h*u-d*c,f=p-S-k;if(0>=f)return!1;var g,m,y,v,b,N,P,O=d-l,_=i-h,G=l-u,M=c-i;if(void 0!==t){var x=c>i?h>i?i:h:h>c?c:h,E=u>l?d>l?l:d:d>u?u:d,A=i>c?i>h?i:h:c>h?c:h,I=l>u?l>d?l:d:u>d?u:d,T=zOrder(x,E,t,r,n),L=zOrder(A,I,t,r,n);for(P=e.nextZ;P&&P.z<=L;)if(g=P.p,P=P.nextZ,g!==s&&g!==o&&(m=g[0],y=g[1],v=O*m+_*y-S,v>=0&&(b=G*m+M*y+p,b>=0&&(N=f-v-b,N>=0&&(v&&b||v&&N||b&&N)))))return!1;for(P=e.prevZ;P&&P.z>=T;)if(g=P.p,P=P.prevZ,g!==s&&g!==o&&(m=g[0],y=g[1],v=O*m+_*y-S,v>=0&&(b=G*m+M*y+p,b>=0&&(N=f-v-b,N>=0&&(v&&b||v&&N||b&&N)))))return!1}else for(P=e.next.next;P!==e.prev;)if(g=P.p,P=P.next,m=g[0],y=g[1],v=O*m+_*y-S,v>=0&&(b=G*m+M*y+p,b>=0&&(N=f-v-b,N>=0&&(v&&b||v&&N||b&&N))))return!1;return!0}function cureLocalIntersections(e,t){var r=!!t.vertices,n=e;do{var s=n.prev,a=n.next.next;if(s.p!==a.p&&intersects(s.p,n.p,n.next.p,a.p)&&locallyInside(s,a)&&locallyInside(a,s)){r?(addIndexedVertex(t,s),addIndexedVertex(t,n),addIndexedVertex(t,a)):(t.push(s.p),t.push(n.p),t.push(a.p)),s.next=a,a.prev=s;var o=n.prevZ,i=n.nextZ&&n.nextZ.nextZ;o&&(o.nextZ=i),i&&(i.prevZ=o),n=e=a}n=n.next}while(n!==e);return n}function splitEarcut(e,t,r,n,s){var a=e;do{for(var o=a.next.next;o!==a.prev;){if(a.p!==o.p&&isValidDiagonal(a,o)){var i=splitPolygon(a,o);return a=filterPoints(a,a.next),i=filterPoints(i,i.next),earcutLinked(a,t,r,n,s),void earcutLinked(i,t,r,n,s)}o=o.next}a=a.next}while(a!==e)}function eliminateHoles(e,t){for(var r=e.length,n=[],s=1;r>s;s++){var a=filterPoints(linkedList(e[s],!1));a&&n.push(getLeftmost(a))}for(n.sort(compareX),s=0;s<n.length;s++)eliminateHole(n[s],t),t=filterPoints(t,t.next);return t}function eliminateHole(e,t){if(t=findHoleBridge(e,t)){var r=splitPolygon(t,e);filterPoints(r,r.next)}}function findHoleBridge(e,t){var r,n,s,a=t,o=e.p,i=o[0],c=o[1],h=-(1/0);do{if(n=a.p,s=a.next.p,c<=n[1]&&c>=s[1]){var l=n[0]+(c-n[1])*(s[0]-n[0])/(s[1]-n[1]);i>=l&&l>h&&(h=l,r=n[0]<s[0]?a:a.next)}a=a.next}while(a!==t);if(!r)return null;var u,d,p,S,k,f,g=r.p[0],m=r.p[1],y=i*m-c*g,v=i*c-c*h,b=c-c,N=i-h,P=c-m,O=g-i,_=y-v-(h*m-c*g),G=0>=_?-1:1,M=r,x=1/0;for(a=r.next;a!==M;)u=a.p[0],d=a.p[1],p=i-u,p>=0&&u>=g&&(S=(b*u+N*d-v)*G,S>=0&&(k=(P*u+O*d+y)*G,k>=0&&_*G-S-k>=0&&(f=Math.abs(c-d)/p,x>f&&locallyInside(a,e)&&(r=a,x=f)))),a=a.next;return r}function indexCurve(e,t,r,n){var s=e;do null===s.z&&(s.z=zOrder(s.p[0],s.p[1],t,r,n)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next;while(s!==e);s.prevZ.nextZ=null,s.prevZ=null,sortLinked(s)}function sortLinked(e){for(var t,r,n,s,a,o,i,c,h=1;;){for(r=e,e=null,a=null,o=0;r;){for(o++,n=r,i=0,t=0;h>t&&(i++,n=n.nextZ,n);t++);for(c=h;i>0||c>0&&n;)0===i?(s=n,n=n.nextZ,c--):0!==c&&n?r.z<=n.z?(s=r,r=r.nextZ,i--):(s=n,n=n.nextZ,c--):(s=r,r=r.nextZ,i--),a?a.nextZ=s:e=s,s.prevZ=a,a=s;r=n}if(a.nextZ=null,1>=o)return e;h*=2}}function zOrder(e,t,r,n,s){return e=1e3*(e-r)/s,e=16711935&(e|e<<8),e=252645135&(e|e<<4),e=858993459&(e|e<<2),e=1431655765&(e|e<<1),t=1e3*(t-n)/s,t=16711935&(t|t<<8),t=252645135&(t|t<<4),t=858993459&(t|t<<2),t=1431655765&(t|t<<1),e|t<<1}function getLeftmost(e){var t=e,r=e;do t.p[0]<r.p[0]&&(r=t),t=t.next;while(t!==e);return r}function isValidDiagonal(e,t){return!intersectsPolygon(e,e.p,t.p)&&locallyInside(e,t)&&locallyInside(t,e)&&middleInside(e,e.p,t.p)}function orient(e,t,r){var n=(t[1]-e[1])*(r[0]-t[0])-(t[0]-e[0])*(r[1]-t[1]);return n>0?1:0>n?-1:0}function equals(e,t){return e[0]===t[0]&&e[1]===t[1]}function intersects(e,t,r,n){return orient(e,t,r)!==orient(e,t,n)&&orient(r,n,e)!==orient(r,n,t)}function intersectsPolygon(e,t,r){var n=e;do{var s=n.p,a=n.next.p;if(s!==t&&a!==t&&s!==r&&a!==r&&intersects(s,a,t,r))return!0;n=n.next}while(n!==e);return!1}function locallyInside(e,t){return-1===orient(e.prev.p,e.p,e.next.p)?-1!==orient(e.p,t.p,e.next.p)&&-1!==orient(e.p,e.prev.p,t.p):-1===orient(e.p,t.p,e.prev.p)||-1===orient(e.p,e.next.p,t.p)}function middleInside(e,t,r){var n=e,s=!1,a=(t[0]+r[0])/2,o=(t[1]+r[1])/2;do{var i=n.p,c=n.next.p;i[1]>o!=c[1]>o&&a<(c[0]-i[0])*(o-i[1])/(c[1]-i[1])+i[0]&&(s=!s),n=n.next}while(n!==e);return s}function compareX(e,t){return e.p[0]-t.p[0]}function splitPolygon(e,t){var r=new Node(e.p),n=new Node(t.p),s=e.next,a=t.prev;return r.source=e,n.source=t,e.next=t,t.prev=e,r.next=s,s.prev=r,n.next=r,r.prev=n,a.next=n,n.prev=a,n}function insertNode(e,t){var r=new Node(e);return t?(r.next=t.next,r.prev=t,t.next.prev=r,t.next=r):(r.prev=r,r.next=r),r}function Node(e){this.p=e,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.source=null,this.index=null}var Sketch=Sketch||{};Sketch.createSketch=function(e){var t=new Sketch.Driver(e);return t.addShaderURL("shaders/sketch-default.json"),t},Sketch.Driver=function(e){this.readyLock=0,this.canvas=e,this.context=e.getContext("webgl",{preserveDrawingBuffer:!0}),this.codeStore=[],this.constantPool=[],this.parser=sketchParse,this.codeGen=new Sketch.SketchGen,this.shaderManager=new Palette.Manager(this.context),this.vm=null},Sketch.Driver.prototype={addShader:function(e){this.readyLock++,this.addShaderInternal(e)},addShaderURL:function(e){this.readyLock++;var t=this,r=new XMLHttpRequest;r.open("GET",e,!0),r.onload=function(){t.addShaderInternal(r.responseText)},r.send()},addShaderInternal:function(e){this.shaderManager.addShader(e),this.readyLock--},compile:function(e){if(this.readyLock>0)return alert("Sketch driver is still loading shaders - be patient! If it's been excessively long then you may have tried to add a malformed shader."),!1;this.vm=null;try{var t=this.parser.parse(e),r=this.codeGen.interpret(t);this.vm=new MVM.VM(this.context,this.shaderManager,r,!0);var n=this.vm.interpret().current();alert("The final values of global scope variables are (in order of definition):\n"+n.variables),alert("The Virtual Machine's final state is in the console."),console.log(n)}catch(s){return alert("Error detected while rendering! See console for stack trace."),console.log(s),!1}return!0}};var sketchParse=function(){function e(){this.yy={}}var t=function(e,t,r,n){for(r=r||{},n=e.length;n--;r[e[n]]=t);return r},r=[1,8],n=[1,37],s=[1,18],a=[1,12],o=[1,19],i=[1,20],c=[1,21],h=[1,22],l=[1,23],u=[1,24],d=[1,25],p=[1,32],S=[1,33],k=[1,34],f=[1,35],g=[1,36],m=[1,26],y=[1,27],v=[1,28],b=[1,29],N=[1,30],P=[1,31],O=[5,10,21,25,29,33,35,36,37,38,39,40,62,63,64,65,66,70,71,72,73,74,75],_=[1,41],G=[5,10,21,25,26,29,33,35,36,37,38,39,40,62,63,64,65,66,70,71,72,73,74,75],M=[2,76],x=[1,44],E=[5,10,21,25,26,29,33,34,35,36,37,38,39,40,62,63,64,65,66,70,71,72,73,74,75],A=[1,46],I=[1,47],T=[1,48],L=[1,49],R=[1,50],w=[5,10,21,22,25,26,29,33,34,35,36,37,38,39,40,42,43,44,45,46,62,63,64,65,66,68,70,71,72,73,74,75],D=[1,67],C=[1,52],V=[1,53],F=[1,54],U=[1,55],$=[1,56],B=[1,57],Z=[1,58],q=[1,59],J=[1,60],H=[1,61],z=[1,62],X=[1,63],Y=[1,64],j=[1,65],K=[1,66],Q=[2,82],W=[1,68],ee=[1,84],te=[25,62],re=[5,10,16,21,22,24,25,26,29,33,34,35,36,37,38,39,40,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,68,70,71,72,73,74,75],ne=[22,24],se=[5,10,16,21,22,24,25,26,29,33,35,36,37,38,39,40,62,63,64,65,66,68,70,71,72,73,74,75],ae=[5,10,21,25,26,29,33,35,36,37,38,39,40,62,63,64,65,66,68,70,71,72,73,74,75],oe=[1,119],ie=[10,21,25,26,29,33,35,36,37,38,39,40,62,63,64,65,66,70,71,72,73,74,75],ce=[2,80],he=[5,10,21,22,25,26,29,33,34,35,36,37,38,39,40,42,43,62,63,64,65,66,68,70,71,72,73,74,75],le=[5,10,21,22,25,26,29,33,34,35,36,37,38,39,40,42,43,44,45,62,63,64,65,66,68,70,71,72,73,74,75],ue=[5,10,21,22,25,26,29,33,34,35,36,37,38,39,40,62,63,64,65,66,68,70,71,72,73,74,75],de=[21,25,62,63,64,65,66],pe=[22,24,26],Se=[19,25],ke={trace:function(){},yy:{},symbols_:{error:2,start:3,program:4,EOF:5,declarations:6,"out-decl":7,"in-decl":8,statement:9,FUNCTION:10,declarator:11,declaration_list:12,func_return:13,body:14,param:15,ASSIGN:16,exp:17,semi:18,RETURN_TYPE:19,type:20,OPEN_PARENS:21,CLOSE_PARENS:22,param_list:23,COMMA:24,OPEN_BRACE:25,CLOSE_BRACE:26,statement_list:27,decl_list:28,"function":29,condition_statements:30,iteration_statements:31,jump_statements:32,IF:33,ELSE:34,WHILE:35,DO:36,FOR:37,CONTINUE:38,BREAK:39,RETURN:40,prim_expr:41,PLUS:42,MINUS:43,MULT:44,DIV:45,MODULO:46,OP_ADD_ASSIGNMENT:47,OP_SUB_ASSIGNMENT:48,OP_MULT_ASSIGNMENT:49,OP_DIV_ASSIGNMENT:50,OP_MOD_ASSIGNMENT:51,OP_INC:52,OP_DEC:53,OP_AND:54,OP_OR:55,OP_EQ:56,LT:57,GT:58,OP_NE:59,OP_LE:60,OP_GE:61,IDENTIFIER:62,NUMBER:63,TRUE:64,FALSE:65,EXCL:66,init_list:67,SEMICOLON:68,declaration:69,VOID:70,NUM:71,BOOL:72,POINT:73,LINE:74,POLYGON:75,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",10:"FUNCTION",16:"ASSIGN",19:"RETURN_TYPE",21:"OPEN_PARENS",22:"CLOSE_PARENS",24:"COMMA",25:"OPEN_BRACE",26:"CLOSE_BRACE",29:"function",33:"IF",34:"ELSE",35:"WHILE",36:"DO",37:"FOR",38:"CONTINUE",39:"BREAK",40:"RETURN",42:"PLUS",43:"MINUS",44:"MULT",45:"DIV",46:"MODULO",47:"OP_ADD_ASSIGNMENT",48:"OP_SUB_ASSIGNMENT",49:"OP_MULT_ASSIGNMENT",50:"OP_DIV_ASSIGNMENT",51:"OP_MOD_ASSIGNMENT",52:"OP_INC",53:"OP_DEC",54:"OP_AND",55:"OP_OR",56:"OP_EQ",57:"LT",58:"GT",59:"OP_NE",60:"OP_LE",61:"OP_GE",62:"IDENTIFIER",63:"NUMBER",64:"TRUE",65:"FALSE",66:"EXCL",68:"SEMICOLON",70:"VOID",71:"NUM",72:"BOOL",73:"POINT",74:"LINE",75:"POLYGON"},productions_:[0,[3,2],[3,1],[4,1],[4,2],[6,1],[6,1],[6,1],[7,5],[8,4],[8,2],[13,2],[13,0],[12,2],[12,3],[23,1],[23,3],[15,2],[14,2],[14,3],[14,3],[14,4],[9,2],[9,1],[9,1],[9,1],[9,1],[9,1],[30,5],[30,7],[31,5],[31,7],[31,9],[32,2],[32,2],[32,3],[32,2],[28,1],[28,1],[28,2],[28,2],[27,1],[27,2],[27,2],[17,1],[17,3],[17,3],[17,3],[17,3],[17,3],[17,3],[17,3],[17,3],[17,3],[17,3],[17,2],[17,2],[17,3],[17,3],[17,3],[17,3],[17,3],[17,3],[17,3],[17,3],[17,3],[41,1],[41,1],[41,1],[41,1],[41,2],[41,3],[41,4],[41,3],[41,3],[18,1],[18,0],[11,1],[69,1],[69,4],[67,1],[67,3],[67,0],[20,1],[20,1],[20,1],[20,1],[20,1],[20,1]],performAction:function(e,t,r,n,s,a,o){var i=a.length-1;switch(s){case 1:return"undefined"!=typeof console?console.log("%j",a[i-1]):print(a[i-1]),a[i-1];case 2:return[];case 4:this.$=[a[i-1],a[i]];break;case 8:this.$={type:Sketch.SketchGenNodes["function"],arguments:[a[i-3],a[i-2],a[i-1],a[i]]};break;case 9:this.$={type:Sketch.SketchGenNodes.variable_decl_assign,arguments:[a[i-3],a[i-1]]};break;case 10:this.$={type:Sketch.SketchGenNodes.variable_decl,arguments:a[i-1]};break;case 11:this.$=a[i];break;case 12:this.$="void";break;case 13:this.$=[];break;case 14:this.$=a[i-1];break;case 15:this.$=[a[i]];break;case 16:this.$=a[i-2],this.$.push(a[i]);break;case 17:this.$={type:Sketch.SketchGenNodes.decl,arguments:[a[i-1],a[i]]};break;case 18:this.$={type:Sketch.SketchGenNodes.block,arguments:[]};break;case 19:case 20:this.$={type:Sketch.SketchGenNodes.block,arguments:a[i-1]};break;case 21:this.$={type:Sketch.SketchGenNodes.block,arguments:[a[i-2],a[i-1]]};break;case 28:this.$={type:"if",arguments:[a[i-2],a[i]]};break;case 29:this.$={type:"if_else",arguments:[a[i-4],a[i-2],a[i]]};break;case 30:this.$={type:"while",arguments:[a[i-2],a[i-1]]};break;case 31:this.$={type:"do_while",arguments:[a[i-5],a[i-2]]};break;case 32:this.$={type:"for",arguments:[a[i-6],a[i-4],a[i-2],a[i]]};break;case 35:this.$={type:Sketch.SketchGenNodes["return"],arguments:a[i-1]};break;case 36:this.$={type:Sketch.SketchGenNodes["return"],arguments:null};break;case 39:case 40:this.$=[a[i-1],a[i]];break;case 41:this.$=[a[i]];break;case 42:case 43:this.$=a[i-1],this.$.push(a[i]);break;case 45:this.$={type:Sketch.SketchGenNodes.addition,arguments:[a[i-2],a[i]]};break;case 46:this.$={type:Sketch.SketchGenNodes.subtraction,arguments:[a[i-2],a[i]]};break;case 47:this.$={type:Sketch.SketchGenNodes.multiplication,arguments:[a[i-2],a[i]]};break;case 48:this.$={type:Sketch.SketchGenNodes.division,arguments:[a[i-2],a[i]]};break;case 49:this.$={type:Sketch.SketchGenNodes.modulo,arguments:[a[i-2],a[i]]};break;case 50:this.$={type:Sketch.SketchGenNodes.add_assign,arguments:[a[i-2],a[i]]};break;case 51:this.$={type:Sketch.SketchGenNodes.sub_assign,arguments:[a[i-2],a[i]]};break;case 52:this.$={type:Sketch.SketchGenNodes.mul_assign,arguments:[a[i-2],a[i]]};break;case 53:this.$={type:Sketch.SketchGenNodes.div_assign,arguments:[a[i-2],a[i]]};break;case 54:this.$={type:Sketch.SketchGenNodes.mod_assign,arguments:[a[i-2],a[i]]};break;case 55:this.$={type:Sketch.SketchGenNodes.increment,arguments:[a[i-1]]};break;case 56:this.$={type:Sketch.SketchGenNodes.decrement,arguments:[a[i-1]]};break;case 57:this.$={type:Sketch.SketchGenNodes.and,arguments:[a[i-2],a[i]]};break;case 58:this.$={type:Sketch.SketchGenNodes.or,arguments:[a[i-2],a[i]]};break;case 59:this.$={type:Sketch.SketchGenNodes.equal,arguments:[a[i-2],a[i]]};break;case 60:this.$={type:Sketch.SketchGenNodes.less_than,arguments:[a[i-2],a[i]]};break;case 61:this.$={type:Sketch.SketchGenNodes.greater_than,arguments:[a[i-2],a[i]]};break;case 62:this.$={type:Sketch.SketchGenNodes.not_equal,arguments:[a[i-2],a[i]]};break;case 63:this.$={type:Sketch.SketchGenNodes.less_than_or_equal,arguments:[a[i-2],a[i]]};break;case 64:this.$={type:Sketch.SketchGenNodes.greater_than_or_equal,arguments:[a[i-2],a[i]]};break;case 65:this.$={type:Sketch.SketchGenNodes.assign,arguments:[a[i-2],a[i]]};break;case 66:this.$={type:Sketch.SketchGenNodes.ident,arguments:e};break;case 67:this.$={type:Sketch.SketchGenNodes.num,arguments:Number(e)};break;case 68:this.$={type:Sketch.SketchGenNodes.bool,arguments:!0};break;case 69:this.$={type:Sketch.SketchGenNodes.bool,arguments:!1};break;case 70:this.$={type:Sketch.SketchGenNodes.negate,arguments:a[i]};break;case 71:case 73:case 74:this.$=a[i-1];break;case 72:this.$={type:Sketch.SketchGenNodes.func_call,arguments:[a[i-3],a[i-1]]};break;case 79:this.$=[a[i-3],a[i-1]];break;case 80:this.$=[a[i]];break;case 81:this.$=a[i-2],this.$.push(a[i]);break;case 82:this.$=[]}},table:[{3:1,4:2,5:[1,3],6:4,7:5,8:6,9:7,10:r,14:11,15:9,17:10,20:16,21:n,25:s,29:a,30:13,31:14,32:15,33:o,35:i,36:c,37:h,38:l,39:u,40:d,41:17,62:p,63:S,64:k,65:f,66:g,70:m,71:y,72:v,73:b,74:N,75:P},{1:[3]},{5:[1,38],6:39,7:5,8:6,9:7,10:r,14:11,15:9,17:10,20:16,21:n,25:s,29:a,30:13,31:14,32:15,33:o,35:i,36:c,37:h,38:l,39:u,40:d,41:17,62:p,63:S,64:k,65:f,66:g,70:m,71:y,72:v,73:b,74:N,75:P},{1:[2,2]},t(O,[2,3]),t(O,[2,5]),t(O,[2,6]),t(O,[2,7]),{11:40,62:_},t(G,M,{18:43,16:[1,42],68:x}),t(E,M,{18:45,42:A,43:I,44:T,45:L,46:R,68:x}),t(E,[2,23]),t(E,[2,24]),t(E,[2,25]),t(E,[2,26]),t(E,[2,27]),{11:51,62:_},t(w,[2,44],{16:D,47:C,48:V,49:F,50:U,51:$,52:B,53:Z,54:q,55:J,56:H,57:z,58:X,59:Y,60:j,61:K}),{7:74,8:73,9:72,10:r,14:11,15:9,17:10,20:16,21:n,24:Q,25:s,26:W,27:69,28:70,29:a,30:13,31:14,32:15,33:o,35:i,36:c,37:h,38:l,39:u,40:d,41:75,62:p,63:S,64:k,65:f,66:g,67:71,70:m,71:y,72:v,73:b,74:N,75:P},{21:[1,76]},{21:[1,77]},{9:78,14:11,17:10,21:n,25:s,29:a,30:13,31:14,32:15,33:o,35:i,36:c,37:h,38:l,39:u,40:d,41:17,62:p,63:S,64:k,65:f,66:g},{21:[1,79]},t(E,M,{18:80,68:x}),t(E,M,{18:81,68:x}),t([5,10,26,29,33,34,35,36,37,38,39,40,70,71,72,73,74,75],M,{41:17,17:82,18:83,21:n,25:ee,62:p,63:S,64:k,65:f,66:g,68:x}),t(te,[2,83]),t(te,[2,84]),t(te,[2,85]),t(te,[2,86]),t(te,[2,87]),t(te,[2,88]),t([5,10,16,22,24,25,26,29,33,34,35,36,37,38,39,40,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,68,70,71,72,73,74,75],[2,66],{21:[1,85]}),t(re,[2,67]),t(re,[2,68]),t(re,[2,69]),{21:n,25:ee,41:86,62:p,63:S,64:k,65:f,66:g},t(ne,Q,{41:75,17:87,67:88,21:n,25:ee,62:p,63:S,64:k,65:f,66:g}),{1:[2,1]},t(O,[2,4]),{12:89,21:[1,90]},t(se,[2,77]),{17:91,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},t(ae,[2,10]),t([5,10,21,25,26,29,33,34,35,36,37,38,39,40,62,63,64,65,66,68,70,71,72,73,74,75],[2,75]),t(E,[2,22]),{17:92,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},{17:93,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},{17:94,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},{17:95,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},{17:96,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},t(se,[2,17]),{17:97,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},{17:98,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},{17:99,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},{17:100,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},{17:101,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},t(w,[2,55]),t(w,[2,56]),{17:102,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},{17:103,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},{17:104,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},{17:105,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},{17:106,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},{17:107,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},{17:108,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},{17:109,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},{17:110,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},t(E,[2,18]),{7:74,8:73,9:112,10:r,14:11,15:9,17:10,20:16,21:n,25:s,26:[1,111],28:113,29:a,30:13,31:14,32:15,33:o,35:i,36:c,37:h,38:l,39:u,40:d,41:17,62:p,63:S,64:k,65:f,66:g,70:m,71:y,72:v,73:b,74:N,75:P},{7:117,8:116,9:72,10:r,14:11,15:9,17:10,20:16,21:n,25:s,26:[1,114],27:115,29:a,30:13,31:14,32:15,33:o,35:i,36:c,37:h,38:l,39:u,40:d,41:17,62:p,63:S,64:k,65:f,66:g,70:m,71:y,72:v,73:b,74:N,75:P},{24:oe,26:[1,118]},t(ie,[2,41]),t(ie,[2,37]),t(ie,[2,38]),t([10,21,22,24,25,26,29,33,35,36,37,38,39,40,42,43,44,45,46,62,63,64,65,66,68,70,71,72,73,74,75],ce,{16:D,47:C,48:V,49:F,50:U,51:$,52:B,53:Z,54:q,55:J,56:H,57:z,58:X,59:Y,60:j,61:K}),{17:120,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},{17:121,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},{35:[1,122]},{8:123,15:9,20:16,70:m,71:y,72:v,73:b,74:N,75:P},t(E,[2,33]),t(E,[2,34]),t(E,M,{18:124,42:A,43:I,44:T,45:L,46:R,68:x}),t(E,[2,36]),t([24,26],Q,{67:71,41:125,21:n,25:ee,62:p,63:S,64:k,65:f,66:g}),t(ne,Q,{41:125,67:126,21:n,25:ee,62:p,63:S,64:k,65:f,66:g}),t(re,[2,70]),{22:[1,127],42:A,43:I,44:T,45:L,46:R},{22:[1,128],24:oe},{13:129,19:[1,130],25:[2,12]},{15:133,20:16,22:[1,131],23:132,70:m,71:y,72:v,73:b,74:N,75:P},t(G,M,{18:134,42:A,43:I,44:T,45:L,46:R,68:x}),t(he,[2,45],{44:T,45:L,46:R}),t(he,[2,46],{44:T,45:L,46:R}),t(le,[2,47],{46:R}),t(le,[2,48],{46:R}),t(ue,[2,49],{42:A,43:I,44:T,45:L,46:R}),t(ue,[2,50],{42:A,43:I,44:T,45:L,46:R}),t(ue,[2,51],{42:A,43:I,44:T,45:L,46:R}),t(ue,[2,52],{42:A,43:I,44:T,45:L,46:R}),t(ue,[2,53],{42:A,43:I,44:T,45:L,46:R}),t(ue,[2,54],{42:A,43:I,44:T,45:L,46:R}),t(ue,[2,57],{42:A,43:I,44:T,45:L,46:R}),t(ue,[2,58],{42:A,43:I,44:T,45:L,46:R}),t(ue,[2,59],{42:A,43:I,44:T,45:L,46:R}),t(ue,[2,60],{42:A,43:I,44:T,45:L,46:R}),t(ue,[2,61],{42:A,43:I,44:T,45:L,46:R}),t(ue,[2,62],{42:A,43:I,44:T,45:L,46:R}),t(ue,[2,63],{42:A,43:I,44:T,45:L,46:R}),t(ue,[2,64],{42:A,43:I,44:T,45:L,46:R}),t(ue,[2,65],{42:A,43:I,44:T,45:L,46:R}),t(E,[2,19]),t(ie,[2,42]),t([21,25,26,29,33,35,36,37,38,39,40,62,63,64,65,66],[2,43],{15:9,20:16,8:116,7:117,10:r,70:m,71:y,72:v,73:b,74:N,75:P}),t(E,[2,20]),{7:74,8:73,9:112,10:r,14:11,15:9,17:10,20:16,21:n,25:s,26:[1,135],28:113,29:a,30:13,31:14,32:15,33:o,35:i,36:c,37:h,38:l,39:u,40:d,41:17,62:p,63:S,64:k,65:f,66:g,70:m,71:y,72:v,73:b,74:N,75:P},t(ie,[2,39]),t(ie,[2,40]),t(re,[2,73]),{21:n,25:ee,41:136,62:p,63:S,64:k,65:f,66:g},{22:[1,137],42:A,43:I,44:T,45:L,46:R},{22:[1,138],42:A,43:I,44:T,45:L,46:R},{21:[1,139]},t(de,M,{18:140,68:x}),t(E,[2,35]),t(pe,ce),{22:[1,141],24:oe},t(re,[2,71]),t(re,[2,74]),{14:142,25:[1,143]},{20:144,70:m,71:y,72:v,73:b,74:N,75:P},t(Se,[2,13]),{22:[1,145],24:[1,146]},t(ne,[2,15]),t(ae,[2,9]),t(E,[2,21]),t(pe,[2,81]),{9:147,14:11,17:10,21:n,25:s,29:a,30:13,31:14,32:15,33:o,35:i,36:c,37:h,38:l,39:u,40:d,41:17,62:p,63:S,64:k,65:f,66:g},{9:148,14:11,17:10,21:n,25:s,29:a,30:13,31:14,32:15,33:o,35:i,36:c,37:h,38:l,39:u,40:d,41:17,62:p,63:S,64:k,65:f,66:g},{17:149,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},{17:150,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},t(re,[2,72]),t(G,[2,8]),{7:74,8:73,9:72,10:r,14:11,15:9,17:10,20:16,21:n,25:s,26:W,27:69,28:70,29:a,30:13,31:14,32:15,33:o,35:i,36:c,37:h,38:l,39:u,40:d,41:17,62:p,63:S,64:k,65:f,66:g,70:m,71:y,72:v,73:b,74:N,75:P},{25:[2,11]},t(Se,[2,14]),{15:151,20:16,70:m,71:y,72:v,73:b,74:N,75:P},t(G,[2,28],{34:[1,152]}),t(E,[2,30]),{22:[1,153],42:A,43:I,44:T,45:L,46:R},t(de,M,{18:154,42:A,43:I,44:T,45:L,46:R,68:x}),t(ne,[2,16]),{9:155,14:11,17:10,21:n,25:s,29:a,30:13,31:14,32:15,33:o,35:i,36:c,37:h,38:l,39:u,40:d,41:17,62:p,63:S,64:k,65:f,66:g},t(E,M,{18:156,68:x}),{17:157,21:n,25:ee,41:17,62:p,63:S,64:k,65:f,66:g},t(E,[2,29]),t(E,[2,31]),{22:[1,158],42:A,43:I,44:T,45:L,46:R},{9:159,14:11,17:10,21:n,25:s,29:a,30:13,31:14,32:15,33:o,35:i,36:c,37:h,38:l,39:u,40:d,41:17,62:p,63:S,64:k,65:f,66:g},t(E,[2,32])],defaultActions:{3:[2,2],38:[2,1],144:[2,11]},parseError:function(e,t){if(!t.recoverable)throw new Error(e);this.trace(e)},parse:function(e){function t(){var e;return e=S.lex()||d,"number"!=typeof e&&(e=r.symbols_[e]||e),e}var r=this,n=[0],s=[null],a=[],o=this.table,i="",c=0,h=0,l=0,u=2,d=1,p=a.slice.call(arguments,1),S=Object.create(this.lexer),k={yy:{}};for(var f in this.yy)Object.prototype.hasOwnProperty.call(this.yy,f)&&(k.yy[f]=this.yy[f]);S.setInput(e,k.yy),k.yy.lexer=S,k.yy.parser=this,"undefined"==typeof S.yylloc&&(S.yylloc={});var g=S.yylloc;a.push(g);var m=S.options&&S.options.ranges;"function"==typeof k.yy.parseError?this.parseError=k.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var y,v,b,N,P,O,_,G,M,x={};;){if(b=n[n.length-1],this.defaultActions[b]?N=this.defaultActions[b]:((null===y||"undefined"==typeof y)&&(y=t()),N=o[b]&&o[b][y]),"undefined"==typeof N||!N.length||!N[0]){var E="";M=[];for(O in o[b])this.terminals_[O]&&O>u&&M.push("'"+this.terminals_[O]+"'");E=S.showPosition?"Parse error on line "+(c+1)+":\n"+S.showPosition()+"\nExpecting "+M.join(", ")+", got '"+(this.terminals_[y]||y)+"'":"Parse error on line "+(c+1)+": Unexpected "+(y==d?"end of input":"'"+(this.terminals_[y]||y)+"'"),this.parseError(E,{text:S.match,token:this.terminals_[y]||y,line:S.yylineno,loc:g,expected:M})}if(N[0]instanceof Array&&N.length>1)throw new Error("Parse Error: multiple actions possible at state: "+b+", token: "+y);switch(N[0]){case 1:n.push(y),s.push(S.yytext),a.push(S.yylloc),n.push(N[1]),y=null,v?(y=v,v=null):(h=S.yyleng,i=S.yytext,c=S.yylineno,g=S.yylloc,l>0&&l--);break;case 2:if(_=this.productions_[N[1]][1],x.$=s[s.length-_],x._$={first_line:a[a.length-(_||1)].first_line,last_line:a[a.length-1].last_line,first_column:a[a.length-(_||1)].first_column,last_column:a[a.length-1].last_column},m&&(x._$.range=[a[a.length-(_||1)].range[0],a[a.length-1].range[1]]),P=this.performAction.apply(x,[i,h,c,k.yy,N[1],s,a].concat(p)),"undefined"!=typeof P)return P;_&&(n=n.slice(0,-1*_*2),s=s.slice(0,-1*_),a=a.slice(0,-1*_)),n.push(this.productions_[N[1]][0]),s.push(x.$),a.push(x._$),G=o[n[n.length-2]][n[n.length-1]],n.push(G);break;case 3:return!0}}return!0}},fe=function(){var e={EOF:1,parseError:function(e,t){if(!this.yy.parser)throw new Error(e);this.yy.parser.parseError(e,t)},setInput:function(e,t){return this.yy=t||this.yy||{},this._input=e,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var e=this._input[0];this.yytext+=e,this.yyleng++,this.offset++,this.match+=e,this.matched+=e;var t=e.match(/(?:\r\n?|\n).*/g);return t?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),e},unput:function(e){var t=e.length,r=e.split(/(?:\r\n?|\n)/g);this._input=e+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-t),this.offset-=t;var n=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),r.length-1&&(this.yylineno-=r.length-1);var s=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:r?(r.length===n.length?this.yylloc.first_column:0)+n[n.length-r.length].length-r[0].length:this.yylloc.first_column-t},this.options.ranges&&(this.yylloc.range=[s[0],s[0]+this.yyleng-t]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(e){this.unput(this.match.slice(e))},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(e.length>20?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;return e.length<20&&(e+=this._input.substr(0,20-e.length)),(e.substr(0,20)+(e.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),t=new Array(e.length+1).join("-");return e+this.upcomingInput()+"\n"+t+"^"},test_match:function(e,t){var r,n,s;if(this.options.backtrack_lexer&&(s={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(s.yylloc.range=this.yylloc.range.slice(0))),n=e[0].match(/(?:\r\n?|\n).*/g),n&&(this.yylineno+=n.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:n?n[n.length-1].length-n[n.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+e[0].length},this.yytext+=e[0],this.match+=e[0],this.matches=e,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(e[0].length),this.matched+=e[0],r=this.performAction.call(this,this.yy,this,t,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),r)return r;if(this._backtrack){for(var a in s)this[a]=s[a];return!1}return!1},next:function(){if(this.done)return this.EOF;this._input||(this.done=!0);var e,t,r,n;this._more||(this.yytext="",this.match="");for(var s=this._currentRules(),a=0;a<s.length;a++)if(r=this._input.match(this.rules[s[a]]),r&&(!t||r[0].length>t[0].length)){if(t=r,n=a,this.options.backtrack_lexer){if(e=this.test_match(r,s[a]),e!==!1)return e;if(this._backtrack){t=!1;continue}return!1}if(!this.options.flex)break}return t?(e=this.test_match(t,s[n]),e!==!1?e:!1):""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var e=this.next();return e?e:this.lex()},begin:function(e){this.conditionStack.push(e)},popState:function(){var e=this.conditionStack.length-1;return e>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(e){return e=this.conditionStack.length-1-Math.abs(e||0),e>=0?this.conditionStack[e]:"INITIAL"},pushState:function(e){this.begin(e)},stateStackSize:function(){return this.conditionStack.length},options:{},performAction:function(e,t,r,n){switch(r){case 0:break;case 1:break;case 2:break;case 3:return 72;case 4:return 39;case 5:return"CLEAR";case 6:return 38;case 7:return 36;case 8:return 34;case 9:return 65;case 10:return 37;case 11:return 10;case 12:return 33;case 13:return 74;case 14:return 71;case 15:return"NOT";case 16:return"NULL";case 17:return 73;case 18:return 75;case 19:return 40;case 20:return 64;case 21:return 70;case 22:return 35;case 23:return 25;case 24:return 26;case 25:return"OPEN_BRACKET";case 26:return"CLOSE_BRACKET";case 27:return 21;case 28:return 22;case 29:return 24;case 30:return"COLON";case 31:return 68;case 32:return 19;case 33:return 16;case 34:return 47;case 35:return 52;case 36:return 42;case 37:return 48;case 38:return 53;case 39:return 43;case 40:return 49;case 41:return 44;case 42:return 50;case 43:return 45;case 44:return 51;case 45:return 46;case 46:return 54;case 47:return 55;case 48:return 56;case 49:return 57;case 50:return 58;case 51:return 59;case 52:return 60;case 53:return 61;case 54:return 66;case 55:return 5;case 56:return 63;case 57:return 62}},rules:[/^(?:\s+)/,/^(?:\/\/.*)/,/^(?:#.*)/,/^(?:bool\b)/,/^(?:break\b)/,/^(?:clear\b)/,/^(?:continue\b)/,/^(?:do\b)/,/^(?:else\b)/,/^(?:false\b)/,/^(?:for\b)/,/^(?:function\b)/,/^(?:if\b)/,/^(?:Line\b)/,/^(?:num\b)/,/^(?:not\b)/,/^(?:null\b)/,/^(?:Point\b)/,/^(?:Polygon\b)/,/^(?:return\b)/,/^(?:true\b)/,/^(?:void\b)/,/^(?:while\b)/,/^(?:\{)/,/^(?:\})/,/^(?:\[)/,/^(?:\])/,/^(?:\()/,/^(?:\))/,/^(?:,)/,/^(?::)/,/^(?:;)/,/^(?:->)/,/^(?:=)/,/^(?:\+=)/,/^(?:\+\+)/,/^(?:\+)/,/^(?:-=)/,/^(?:--)/,/^(?:-)/,/^(?:\*=)/,/^(?:\*)/,/^(?:\/=)/,/^(?:\/)/,/^(?:%=)/,/^(?:%)/,/^(?:&&)/,/^(?:\|\|)/,/^(?:\?=)/,/^(?:\?<)/,/^(?:\?>)/,/^(?:!=)/,/^(?:!>)/,/^(?:!<)/,/^(?:!)/,/^(?:$)/,/^(?:[0-9]+(\.[0-9]*)?)/,/^(?:[a-zA-Z_]+[a-zA-Z0-9_]*)/],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57],inclusive:!0}}};return e}();return ke.lexer=fe,e.prototype=ke,ke.Parser=e,new e}();"undefined"!=typeof require&&"undefined"!=typeof exports&&(exports.parser=sketchParse,exports.Parser=sketchParse.Parser,exports.parse=function(){return sketchParse.parse.apply(sketchParse,arguments)},exports.main=function(e){e[1]||(console.log("Usage: "+e[0]+" FILE"),process.exit(1));var t=require("fs").readFileSync(require("path").normalize(e[1]),"utf8");return exports.parser.parse(t)},"undefined"!=typeof module&&require.main===module&&exports.main(process.argv.slice(1)));var MVM=MVM||{};MVM.DataModel=function(){this.root=new MVM.StackFrame(null),this.stack=[this.root]},MVM.DataModel.prototype={current:function(){try{return this.stack[this.stack.length-1]}catch(e){return void 0}},relative:function(e){
for(var t=this.current();e>0&&t&&t.parent;)t=t.parent,e--;if(e>0)throw"Invalid relative call - too few parents.";return t},enter:function(){var e=new MVM.StackFrame(this.current());return this.stack[this.stack.length-1]=e,this},exit:function(){if(this.current()===this.root)throw"Tried to exit from scope past root level.";return this.stack[this.stack.length-1]=this.current().parent,this},call:function(e,t,r){var n=this.current(),s=this.relative(t);this.stack.push(new MVM.StackFrame(s));var a=this.current();for(a.returnAddr=r;e>0;)a.setVar(e-1,n.pop()),e--;return this},funcreturn:function(e){var t=this.stack.pop();return null!==e&&this.current().push(e),t.returnAddr}},MVM.StackFrame=function(e){this.parent=e,this.variables=[],this.stack=[],this.returnAddr=void 0},MVM.StackFrame.prototype={push:function(e){return this.stack.push(e),this},pop:function(){return this.stack.pop()},peek:function(){try{return this.stack[this.stack.length-1]}catch(e){return void 0}},setVar:function(e,t){return this.variables[e]=t,this},getVar:function(e){return this.variables[e]}};var MVM=MVM||{};MVM.VM=function(e,t,r,n){function s(e,t,r){var n=e[0],s=e[1],a=t[0],o=t[1],i=Math.sin(r*(Math.PI/180)),c=Math.cos(r*(Math.PI/180));a-=n,o-=s;var h=a*c-o*i,l=a*i+o*c;h+=n,l+=s;var u=[h,l];return u}var a,o=[],i=[],e=e,t=t,c=0,h=0;window.MVM.dataStore=[];var l=new MVM.DataModel,u=0,d=0;this.interpret=function(){var p=window.MVM.dataStore;n&&console.log(r),a=r.length;for(var S=MVM.opCodes;a>h&&0==d;){c++;var k=r[h];switch(h++,k){case S.STOREG:var f=r[h++],g=l.current().pop();l.root.setVar(f,g),n&&console.log("STOREG: "+g+" in index "+f);break;case S.LOADG:var f=r[h++],g=l.root.getVar(f);l.current().push(g),n&&console.log("LOADG: "+g+" from index "+f);break;case S.STOREL:var f=r[h++],g=l.current().pop();l.current().setVar(f,g),n&&console.log("STOREL: "+g+" in index "+f);break;case S.LOADL:var f=r[h++],g=l.current().getVar(f);l.current().push(g),n&&console.log("LOADL: "+g+" from index "+f);break;case S.LOADC:var m=r[h++];l.current().push(m),n&&console.log("LOADC: "+m);break;case S.IADD:var y=Math.floor(l.current().pop()),v=Math.floor(l.current().pop()),b=v+y;l.current().push(b),n&&console.log("IADD: "+v+" + "+y+" = "+b);break;case S.ISUB:var y=Math.floor(l.current().pop()),v=Math.floor(l.current().pop()),b=v-y;l.current().push(b),n&&console.log("ISUB: "+v+" - "+y+" = "+b);break;case S.IMUL:var y=Math.floor(l.current().pop()),v=Math.floor(l.current().pop()),b=v*y;l.current().push(b),n&&console.log("IMUL: "+v+" * "+y+" = "+b);break;case S.IDIV:var y=Math.floor(l.current().pop()),v=Math.floor(l.current().pop()),b=Math.floor(v/y);l.current().push(b),n&&console.log("IDIV: "+v+" / "+y+" = "+b);break;case S.IMOD:var y=Math.floor(l.current().pop()),v=Math.floor(l.current().pop()),b=Math.floor(v%y);l.current().push(b),n&&console.log("IMOD: "+v+" % "+y+" = "+b);break;case S.FADD:var y=l.current().pop(),v=l.current().pop(),b=v+y;l.current().push(b),n&&console.log("FADD: "+v+" + "+y+" = "+b);break;case S.FSUB:var y=l.current().pop(),v=l.current().pop(),b=v-y;l.current().push(b),n&&console.log("FSUB: "+v+" - "+y+" = "+b);break;case S.FMUL:var y=l.current().pop(),v=l.current().pop(),b=v*y;l.current().push(b),n&&console.log("FMUL: "+v+" * "+y+" = "+b);break;case S.FDIV:var y=l.current().pop(),v=l.current().pop(),b=v/y;l.current().push(b),n&&console.log("FDIV: "+v+" / "+y+" = "+b);break;case S.FMOD:var y=l.current().pop(),v=l.current().pop(),b=v%y;l.current().push(b),n&&console.log("FMOD: "+v+" % "+y+" = "+b);break;case S.CMPEQ:var y=l.current().pop(),v=l.current().pop(),b=v==y;l.current().push(b),n&&console.log("CMPEQ: "+v+" == "+y+" = "+b);break;case S.CMPLT:var y=l.current().pop(),v=l.current().pop(),b=y>v;l.current().push(b),n&&console.log("CMPLT: "+v+" < "+y+" = "+b);break;case S.CMPGT:var y=l.current().pop(),v=l.current().pop(),b=v>y;l.current().push(b),n&&console.log("CMPGT: "+v+" > "+y+" = "+b);break;case S.JUMP:var N=r[h];h=N,n&&console.log("JUMP: "+N);break;case S.JUMPT:var N=i[r[h]];u--;var y=p[u];b=1==y,b?h=r[h]:h++,n&&console.log("JUMPT: "+y+" "+b);break;case S.JUMPF:var N=i[r[h]];u--;var y=p[u],b=0==y;n&&console.log("JUMPF: "+y+" "+b),b?h=r[h]:h++;break;case S.CALL:var P=r[h++],O=r[h++],_=r[h++],G=h;l.call(_,P,G),h=O,n&&console.log("CALL: "+O+"  with "+_+" arguments, return to "+G);break;case S.RETURNVAL:var M=l.current().pop();h=l.funcreturn(M),n&&console.log("RETURNVAL: "+M+" returned, exiting function. New code pointer is "+h);break;case S.RETURN:h=l.funcreturn(null),n&&console.log("RETURN: void return, exiting function.");break;case S.LNDRAW:u--;var x=p[u],E=o[x],A=E[0],I=E[1],T=E[2],L=E[3],R=E[4],w=E[5],D=E[6],C=E[7],V=new Float32Array([R,w,0,D,C,0]),F=new Float32Array([A,I,T,L]),U=t.getProgram("square","square"),$=e.canvas.width,B=e.canvas.height;U.setDrawMode(Palette.Program.LINES),U.draw(V,{width:[$],height:[B]},{color:F}),n&&console.log("LNDRAW: "+E);break;case S.PGDRAW:u--;var y,Z=p[u],q=o[Z],A=q[0],I=q[1],T=q[2],L=q[3],F=new Float32Array([A,I,T,L]),J=[];for(y=4;y<q.length;y+=2){var H=[q[y],q[y+1]];J.push(H)}var U=t.getProgram("square","square");U.setDrawMode(Palette.Program.POLYGON);var $=e.canvas.width,B=e.canvas.height;U.draw(J,{width:[$],height:[B]},{color:F}),n&&console.log("PGDRAW: "+q);break;case S.RENDER:d=1,n&&console.log("RENDER");break;case S.CLEAR:e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),n&&console.log("CLEAR");break;case S.EXIT:h=a,console.log("EXIT");break;case S.LOADIDX:var z=r[h];h++;var X=r[h];h++;var Y=o[z],M=Y[X];p[u]=M,u++,n&&console.log("LOADIDX: constant pool index "+z+" array index: "+X);break;case S.SETIDX:var z=r[h];h++;var X=r[h];h++;var Y=o[z];u--;var M=p[u];Y[X]=M,n&&console.log("SETIDX: constant pool index "+z+" array index: "+X);break;case S.LNTOPG:u--;var x=p[u];u--;for(var j=p[u],K=o[x],Q=K.slice(0),y=2,W=360/j,ee=4,te=5,re=6,ne=7,se=8,ae=9;j>y;){var oe=[Q[ee],Q[te]],ie=[Q[re],Q[ne]],ce=s(oe,ie,W);offSetx=Q[ee]-Q[re],offSety=Q[te]-Q[ne],ce[0]-=offSetx,ce[1]-=offSety,Q[se]=ce[0],Q[ae]=ce[1],ee+=2,te+=2,re+=2,ne+=2,se+=2,ae+=2,y++}var he=r[h];h++,o[he]=Q,n&&console.log("LNTOPG "+Q);break;case S.PTADD:u--;var le=p[u],ue=o[le];u--;var de=p[u],pe=o[de],K=[0,1,0,1,pe[0],pe[1],ue[0],ue[1]],x=r[h];h++,o[x]=K,n&&console.log("PTADD "+K);break;case S.LNMUL:u--;var Se=p[u];u--;var x=p[u],K=o[x];R=K[4],w=K[5],D=K[6],C=K[7];var ke=D-R,fe=C-w,ge=ke*Se-ke,me=fe*Se-fe,ye=r[h];h++;var ve=K.slice(0);ve[6]+=ge,ve[7]+=me,ve[0]=0,ve[1]=1,ve[2]=0,ve[3]=1,o[ye]=ve,n&&console.log("LNMUL "+ve);break;case S.STORER:var be=r[h++],f=r[h++],g=l.current().pop();l.relative(be).setVar(f,g),n&&console.log("STORER: placed "+g+" in index "+f+" of relative frame "+be+".");break;case S.LOADR:var be=r[h++],f=r[h++],g=l.relative(be).getVar(f);l.current().push(g),n&&console.log("LOADR: retrieved "+g+" from index "+f+" of relative frame "+be+".");break;case S.POPSC:n&&(console.log("POPSC: exiting scope:"),console.log(l.current())),l.exit(),n&&console.log("POPSC: exited current block level.");break;case S.PUSHSC:l.enter(),n&&console.log("PUSHSC: entered new block level.");break;case S.BAND:var y=l.current().pop(),v=l.current().pop(),b=v&&y;l.current().push(b),n&&console.log("BAND: "+v+" && "+y+" = "+b);break;case S.BOR:var y=l.current().pop(),v=l.current().pop(),b=v||y;l.current().push(b),n&&console.log("BOR: "+v+" || "+y+" = "+b);break;case S.BNEG:var y=l.current().pop(),b=!y;l.current().push(b),n&&console.log("BNEG: !"+y+" = "+b)}}return d&&render(),l},render=function(){d=0,window.requestAnimationFrame(window.mvm.interpret)}},MVM.opCodes={STOREG:0,LOADG:1,STOREL:2,LOADL:3,LOADC:4,IADD:5,ISUB:6,IMUL:7,IDIV:8,IMOD:9,FADD:10,FSUB:11,FMUL:12,FDIV:13,FMOD:14,LOADIDX:15,SETIDX:16,CMPEQ:17,CMPLT:18,CMPGT:19,JUMP:20,JUMPT:21,JUMPF:22,CALL:23,RETURN:24,LNDRAW:25,PGDRAW:26,RENDER:27,CLEAR:28,PTADD:29,LNTOPG:30,LNMUL:31,EXIT:32,STORER:33,LOADR:34,POPSC:35,PUSHSC:36,RETURNVAL:37,BAND:38,BOR:39,BNEG:40};var Sketch=Sketch||{};Sketch.SketchGen=function(){var e=[],t=0,r=[],n=0,s=[],a=!0,o=Sketch.bindInstructions(this);this.emit=function(r){return e.push(r),t++},this.patch=function(t,r){e[t]=r},this.pc=function(){return t},this.interpretNode=function(e,t){return Array.isArray(e)?void e.forEach(this.interpretNode.bind(this)):""===e?void 0:(a&&(console.log("{\n"+Sketch.SketchGenNodes._rev[e.type]+","),console.log(e.arguments),console.log("}")),o[e.type](e.arguments,t))},this.scopePush=function(e){r.push(new Sketch.SketchGen.ScopeStackFrame),n++,e||this.emit(MVM.opCodes.PUSHSC)},this.scopePop=function(e){r.pop(),n--,e||this.emit(MVM.opCodes.POPSC)},this.scopeRegister=function(e,s,a){var o=r[n];if(o.labelTable[e])throw"Illegal attempt to redefine variable "+e+".";var i="function"===s?t:o.nextData++;o.labelTable[e]=new Sketch.SketchGen.Label(i,s,a)},this.scopeLookup=function(e){var t=0,s=null;for(null;n-t>=0;t++){var a=r[n-t],o=a.labelTable[e];if(o){s={entry:o,stack:t};break}}if(null===s)throw"BAD LOOKUP.";return s},this.interpret=function(t){return this.cleanState(),this.interpretNode({type:Sketch.SketchGenNodes.program,arguments:t}),e},this.cleanState=function(){e=[],t=0,r=[],r.push(new Sketch.SketchGen.ScopeStackFrame),n=0,s=[]},this.beginFunction=function(e){s.push(e)},this.endFunction=function(){s.pop()},this.currentFunctionType=function(){if(0===s.length)throw"Not currently defining a function, can't find its type!";return s[s.length-1]}},Sketch.SketchGen.ScopeStackFrame=function(){this.labelTable={},this.nextData=0},Sketch.SketchGen.Label=function(e,t,r){this.address=e,this.type=t,r&&(this.extra=r)},Sketch.sketchGenDefaultReturns={"void":null,num:0,bool:!1,point:[0,0],line:[0,0,0,0],polygon:[0,0,0,0,0,0]},Sketch.EnumBase=function(){_count=0,this._rev=[],this.propAdd=function(e){this._rev[_count]=e,this[e]=_count++}},Sketch.SketchGenNodes=new Sketch.EnumBase,Sketch.SketchGenNodes.propAdd("program"),Sketch.SketchGenNodes.propAdd("block"),Sketch.SketchGenNodes.propAdd("function"),Sketch.SketchGenNodes.propAdd("func_call"),Sketch.SketchGenNodes.propAdd("return"),Sketch.SketchGenNodes.propAdd("variable_decl"),Sketch.SketchGenNodes.propAdd("variable_decl_assign"),Sketch.SketchGenNodes.propAdd("decl"),Sketch.SketchGenNodes.propAdd("assign"),Sketch.SketchGenNodes.propAdd("addition"),Sketch.SketchGenNodes.propAdd("subtraction"),Sketch.SketchGenNodes.propAdd("multiplication"),Sketch.SketchGenNodes.propAdd("division"),Sketch.SketchGenNodes.propAdd("modulo"),Sketch.SketchGenNodes.propAdd("increment"),Sketch.SketchGenNodes.propAdd("decrement"),Sketch.SketchGenNodes.propAdd("add_assign"),Sketch.SketchGenNodes.propAdd("sub_assign"),Sketch.SketchGenNodes.propAdd("mul_assign"),Sketch.SketchGenNodes.propAdd("div_assign"),Sketch.SketchGenNodes.propAdd("mod_assign"),Sketch.SketchGenNodes.propAdd("and"),Sketch.SketchGenNodes.propAdd("or"),Sketch.SketchGenNodes.propAdd("equal"),Sketch.SketchGenNodes.propAdd("not_equal"),Sketch.SketchGenNodes.propAdd("negate"),Sketch.SketchGenNodes.propAdd("less_than"),Sketch.SketchGenNodes.propAdd("greater_than"),Sketch.SketchGenNodes.propAdd("less_than_or_equal"),Sketch.SketchGenNodes.propAdd("greater_than_or_equal"),Sketch.SketchGenNodes.propAdd("num"),Sketch.SketchGenNodes.propAdd("ident"),Sketch.SketchGenNodes.propAdd("bool");var createNode=function(e,t){return{type:Sketch.SketchGenNodes[e],arguments:t}},boolNegateNode=function(e){return createNode("negate",e)},loadAndOperate=function(e,t,r){for(var n=[],s=0;s<t.length;s++){var a=e.interpretNode(t[s]);"ident"===a.type?n.push(a.data.entry.type):n.push(a.type)}var o=Sketch.SketchGenOperandTable.lookup(r,n);return e.emit(o.value.code),o.value},primitive=function(e,t,r){return e.emit(MVM.opCodes.LOADC),e.emit(t),{type:r}},assignmentOperand=function(e,t,r){e.interpretNode({type:Sketch.SketchGenNodes.assign,arguments:[t[0],{type:Sketch.SketchGenNodes[r],arguments:[t[0],t[1]]}]})},increment=function(e,t,r){return e.interpretNode(t[0]),assignmentOperand(e,[t[0],{type:Sketch.SketchGenNodes.num,arguments:r}],"addition"),Sketch.SketchGenOperandTable.lookup(r>0?"++":"--",[Sketch.SketchGenNodes._rev[t[0].type]]).value};Sketch.SketchGenInstr=[],Sketch.SketchGenInstr[Sketch.SketchGenNodes.program]=function(e){this.interpretNode(e),this.emit(MVM.opCodes.EXIT)},Sketch.SketchGenInstr[Sketch.SketchGenNodes.block]=function(e,t){this.scopePush(t),this.interpretNode(e),this.scopePop(t)},Sketch.SketchGenInstr[Sketch.SketchGenNodes["function"]]=function(e){this.beginFunction(e[2]),this.emit(MVM.opCodes.JUMP);var t=this.emit(255),r=[];e[1].forEach(function(e){r.push(e.arguments[0])}),this.scopeRegister(e[0],"function",{returnType:e[2],paramTypes:r}),this.interpretNode({type:Sketch.SketchGenNodes.block,arguments:[e[1],e[3].arguments]},!0);var n=Sketch.sketchGenDefaultReturns[e[2]];return null===n?this.emit(MVM.opCodes.RETURN):(this.interpretNode({type:Sketch.SketchGenNodes[e[2]],arguments:n}),this.emit(MVM.opCodes.RETURNVAL)),this.patch(t,this.pc()),this.endFunction(),{type:"function"}},Sketch.SketchGenInstr[Sketch.SketchGenNodes.func_call]=function(e){var t=this.scopeLookup(e[0]);if(console.log(t),"function"!==t.entry.type)throw"Tried to call "+e[0]+" as though it were a function - it is a "+t.type+"!";if(void 0===e[1].length&&(e[1].length=0),t.entry.extra.paramTypes.length!==e[1].length)throw"Parameter length mismatch.";for(var r=0;r<e[1].length;r++){var n=this.interpretNode(e[1][r]).type,s=t.entry.extra.paramTypes[r];if(n!==s)throw"Type mismatch on parameter "+r+" of call to "+e[0]+": EXPECTED "+s+", not"+n+"."}return this.emit(MVM.opCodes.CALL),this.emit(t.stack),this.emit(t.entry.address),this.emit(e[1].length),{type:t.entry.extra.returnType}},Sketch.SketchGenInstr[Sketch.SketchGenNodes["return"]]=function(e){if(null===e)this.emit(MVM.opCodes.RETURN);else{var t=this.interpretNode(e).type;this.emit(MVM.opCodes.RETURNVAL);var r=this.currentFunctionType();if(t!==r)throw"ERROR: expected return type of "+r+", given "+t+"."}return{type:null}},Sketch.SketchGenInstr[Sketch.SketchGenNodes.variable_decl]=function(e){this.interpretNode(e)},Sketch.SketchGenInstr[Sketch.SketchGenNodes.variable_decl_assign]=function(e){this.interpretNode(e[0]),this.interpretNode({type:Sketch.SketchGenNodes.assign,arguments:[{type:Sketch.SketchGenNodes.ident,arguments:e[0].arguments[1]},e[1]]})},Sketch.SketchGenInstr[Sketch.SketchGenNodes.decl]=function(e){return this.scopeRegister(e[1],e[0]),e[0]},Sketch.SketchGenInstr[Sketch.SketchGenNodes.assign]=function(e){var t=this.interpretNode(e[0],!0),r=this.interpretNode(e[1]);if("ident"!==t.type)throw"ERROR: non-identity type on left side of assignment operator.";if(r.type!==t.data.entry.type&&r.data.entry.type!==t.data.entry.type)throw console.log("Ltype: "+t.data.entry.type+", Rtype: "+r.type),"ERROR: right side of assignment does not match type of identifier.";return this.emit(MVM.opCodes.STORER),this.emit(t.data.stack),this.emit(t.data.entry.address),r},Sketch.SketchGenInstr[Sketch.SketchGenNodes.addition]=function(e){return loadAndOperate(this,e,"+")},Sketch.SketchGenInstr[Sketch.SketchGenNodes.subtraction]=function(e){return loadAndOperate(this,e,"-")},Sketch.SketchGenInstr[Sketch.SketchGenNodes.multiplication]=function(e){return loadAndOperate(this,e,"*")},Sketch.SketchGenInstr[Sketch.SketchGenNodes.division]=function(e){return loadAndOperate(this,e,"/")},Sketch.SketchGenInstr[Sketch.SketchGenNodes.modulo]=function(e){return loadAndOperate(this,e,"%")},Sketch.SketchGenInstr[Sketch.SketchGenNodes.increment]=function(e){return increment(this,e,1)},Sketch.SketchGenInstr[Sketch.SketchGenNodes.decrement]=function(e){return increment(this,e,-1)},Sketch.SketchGenInstr[Sketch.SketchGenNodes.add_assign]=function(e){return assignmentOperand(this,e,"addition")},Sketch.SketchGenInstr[Sketch.SketchGenNodes.sub_assign]=function(e){return assignmentOperand(this,e,"subtraction")},Sketch.SketchGenInstr[Sketch.SketchGenNodes.mul_assign]=function(e){return assignmentOperand(this,e,"multiplication")},Sketch.SketchGenInstr[Sketch.SketchGenNodes.div_assign]=function(e){return assignmentOperand(this,e,"division")},Sketch.SketchGenInstr[Sketch.SketchGenNodes.mod_assign]=function(e){return assignmentOperand(this,e,"modulo")},Sketch.SketchGenInstr[Sketch.SketchGenNodes.and]=function(e){return loadAndOperate(this,e,"&&")},Sketch.SketchGenInstr[Sketch.SketchGenNodes.or]=function(e){return loadAndOperate(this,e,"||")},Sketch.SketchGenInstr[Sketch.SketchGenNodes.equal]=function(e){return loadAndOperate(this,e,"?=")},Sketch.SketchGenInstr[Sketch.SketchGenNodes.not_equal]=function(e){return this.interpretNode(boolNegateNode(createNode("equal",e)))},Sketch.SketchGenInstr[Sketch.SketchGenNodes.negate]=function(e){return loadAndOperate(this,[e],"!")},Sketch.SketchGenInstr[Sketch.SketchGenNodes.less_than]=function(e){return loadAndOperate(this,e,"?<")},Sketch.SketchGenInstr[Sketch.SketchGenNodes.greater_than]=function(e){return loadAndOperate(this,e,"?>")},Sketch.SketchGenInstr[Sketch.SketchGenNodes.less_than_or_equal]=function(e){return this.interpretNode(boolNegateNode(createNode("greater_than",e)))},Sketch.SketchGenInstr[Sketch.SketchGenNodes.greater_than_or_equal]=function(e){return this.interpretNode(boolNegateNode(createNode("less_than",e)))},Sketch.SketchGenInstr[Sketch.SketchGenNodes.num]=function(e){return primitive(this,e,"num")},Sketch.SketchGenInstr[Sketch.SketchGenNodes.ident]=function(e,t){var r=this.scopeLookup(e);return t||(this.emit(MVM.opCodes.LOADR),this.emit(r.stack),this.emit(r.entry.address)),{type:"ident",data:r}},Sketch.SketchGenInstr[Sketch.SketchGenNodes.bool]=function(e){return primitive(this,e,"bool")},Sketch.bindInstructions=function(e){for(var t=[],r=0;r<Sketch.SketchGenInstr.length;r++)t[r]=Sketch.SketchGenInstr[r].bind(e);return t},Sketch.MultiKeyTable=function(){this.store={}},Sketch.MultiKeyTable.prototype={add:function(e,t,r){var n=new Sketch.MultiKeyTableEntry(this,e,t,r);this.store[e]||(this.store[e]={});for(var s=this.store[e],a=0;a<t.length;a++)s[t[a]]||(s[t[a]]={}),s=s[t[a]];return s.content=n,n},lookup:function(e,t){try{for(var r=this.store[e],n=0;n<t.length;n++)r=r[t[n]];if(r.content)return r.content;throw"No associated entry..."}catch(s){throw"Operand and key combination not found for: "+e+" and "+t}}},Sketch.MultiKeyTableEntry=function(e,t,r,n){this.parent=e,this.keys=r,this.value=n},Sketch.MultiKeyTableEntry.prototype={reflexive:function(){this.parent.add(this.keys.reverse(),this.value)}},Sketch.OpCheckValue=function(e,t){this.type=e,this.code=t},Sketch.SketchGenOperandTable=new Sketch.MultiKeyTable,Sketch.SketchGenOperandTable.add("+",["num","num"],new Sketch.OpCheckValue("num",MVM.opCodes.FADD)),Sketch.SketchGenOperandTable.add("+",["point","point"],new Sketch.OpCheckValue("line",MVM.opCodes.PTADD)),Sketch.SketchGenOperandTable.add("+",["point","line"],new Sketch.OpCheckValue("polygon",null)).reflexive(),Sketch.SketchGenOperandTable.add("+",["point","polygon"],new Sketch.OpCheckValue("polygon",null)).reflexive(),Sketch.SketchGenOperandTable.add("-",["num","num"],new Sketch.OpCheckValue("num",MVM.opCodes.FSUB)),Sketch.SketchGenOperandTable.add("*",["num","num"],new Sketch.OpCheckValue("num",MVM.opCodes.FMUL)),Sketch.SketchGenOperandTable.add("/",["num","num"],new Sketch.OpCheckValue("num",MVM.opCodes.FDIV)),Sketch.SketchGenOperandTable.add("%",["num","num"],new Sketch.OpCheckValue("num",MVM.opCodes.FMOD)),Sketch.SketchGenOperandTable.add("++",["ident"],new Sketch.OpCheckValue("num",null)),Sketch.SketchGenOperandTable.add("--",["ident"],new Sketch.OpCheckValue("num",null)),Sketch.SketchGenOperandTable.add("&&",["bool","bool"],new Sketch.OpCheckValue("bool",MVM.opCodes.BAND)),Sketch.SketchGenOperandTable.add("||",["bool","bool"],new Sketch.OpCheckValue("bool",MVM.opCodes.BOR)),Sketch.SketchGenOperandTable.add("?=",["bool","bool"],new Sketch.OpCheckValue("bool",MVM.opCodes.CMPEQ)),Sketch.SketchGenOperandTable.add("?=",["num","num"],new Sketch.OpCheckValue("bool",MVM.opCodes.CMPEQ)),Sketch.SketchGenOperandTable.add("?=",["point","point"],new Sketch.OpCheckValue("bool",MVM.opCodes.CMPEQ)),Sketch.SketchGenOperandTable.add("?=",["line","line"],new Sketch.OpCheckValue("bool",MVM.opCodes.CMPEQ)),Sketch.SketchGenOperandTable.add("?=",["polygon","polygon"],new Sketch.OpCheckValue("bool",MVM.opCodes.CMPEQ)),Sketch.SketchGenOperandTable.add("?<",["num","num"],new Sketch.OpCheckValue("bool",MVM.opCodes.CMPLT)),Sketch.SketchGenOperandTable.add("?>",["num","num"],new Sketch.OpCheckValue("bool",MVM.opCodes.CMPGT)),Sketch.SketchGenOperandTable.add("!",["bool"],new Sketch.OpCheckValue("bool",MVM.opCodes.BNEG));var Palette=Palette||{};Palette.Manager=function(e){this.context=e,this.vertShaders={},this.fragShaders={},this.programs={},this.shaderFactory=new Palette.ShaderFactory(this)},Palette.Manager.prototype={addShader:function(e){this.shaderFactory.addShader(e)},draw:function(e,t,r,n,s){this.getProgram(e,t).draw(r,n,s)},getProgram:function(e,t){var r,n,s,a=this.getShaderName(e),o=this.getShaderName(t);return this.programs[a]=this.programs[a]||{},this.programs[a][o]=this.programs[a][o]||{},this.programs[a][o]instanceof Palette.Program||(r=e instanceof Palette.Shader?e:this.getShader(Palette.Shader.VS,a),n=t instanceof Palette.Shader?t:this.getShader(Palette.Shader.FS,o),this.programs[a][o]=new Palette.Program(this.context,r,n)),s=this.programs[a][o]},getShader:function(e,t){return e===Palette.Shader.VS?this.vertShaders[t]:this.fragShaders[t]},getShaderName:function(e){var t;return t=e instanceof Palette.Shader?e.name:e}},Palette.Manager.prototype.constructor=Palette.Manager,Palette.Program=function(e,t,r){this.context=e,this.vs=t,this.fs=r,this.program=null,this.compiled=!1,this.attrs={vs:{access:{},store:{},send:{}},fs:{access:{},store:{},send:{}}},this.drawMode=Palette.Program.TRIANGLES,this.linkProgram(),this.prepareAttrStores()},Palette.Program.prototype={draw:function(e,t,r){this.context.useProgram(this.program),t||(t={});var n=this.drawMode;if(null!==e)switch(this.drawMode){case Palette.Program.POLYGON:for(var s=earcut([e],!0),a=this.attrs.vs.access.vertexBuffer.itemSize,o=new Float32Array(s.indices.length*a),i=e[0].length,c=0;c<s.indices.length;c++){var h=s.indices[c];switch(i){case 3:o[a*c+2]=s.vertices[h*i+2];case 2:o[a*c+1]=s.vertices[h*i+1];case 1:o[a*c]=s.vertices[h*i]}}t.vertexBuffer=o,n=Palette.Program.TRIANGLES;break;default:t.vertexBuffer=e}this.generateSend(this.attrs.vs,t),this.generateSend(this.attrs.fs,r),this.passAttrstoProg(),this.context.drawArrays(n,0,this.attrs.vs.send.vertexBuffer.length/this.attrs.vs.access.vertexBuffer.itemSize)},restoreDefaultConfig:function(e){for(var t,r,n=0;2>n;n++){if(n){if(!e&Palette.Program.FS_MODE)continue;r=this.fs,t=this.attrs.fs}else{if(!e&Palette.Program.VS_MODE)continue;r=this.vs,t=this.attrs.vs}for(var s=r.attrs.length-1;s>=0;s--){var a=r.attrs[s],o=a[0];"buffer"==a[1]||"vertexAttrib"==a[1]?t.store[o]=null:"vertexAttrib"!=a[1]&&(t.store[o]=a[2])}}},setConfig:function(e,t){for(var r,n,s=0;2>s;s++){if(s){if(!e&Palette.Program.FS_MODE)continue;n=this.fs,r=this.attrs.fs}else{if(!e&Palette.Program.VS_MODE)continue;n=this.vs,r=this.attrs.vs}for(var a in r.access){var o=r.store[a];void 0!==t[a]&&(o=t[a])}}},linkProgram:function(){return this.compiled?!1:(this.compiled=!0,this.program=this.context.createProgram(),this.context.attachShader(this.program,this.vs.shader),this.context.attachShader(this.program,this.fs.shader),this.context.linkProgram(this.program),!0)},prepareAttrStores:function(){this.context.useProgram(this.program);for(var e,t,r=0;2>r;r++){r?(e=this.fs,t=this.attrs.fs):(e=this.vs,t=this.attrs.vs);for(var n=e.attrs.length-1;n>=0;n--){var s=e.attrs[n],a=s[0];t.access[a]=t.access[a]||{};var o=t.access[a];o.setFunction=Palette.Program.fetchSetter(this.context,s[1]),"vertexAttrib"==s[1]?(o.pointer=this.context.getAttribLocation(this.program,s[0]),this.context.enableVertexAttribArray(o.pointer),o.bufferName=s[2]):"buffer"==s[1]?(o.pointer=this.context.createBuffer(),o.itemSize=s[2]):o.pointer=this.context.getUniformLocation(this.program,s[0]),o.type=s[1]}}this.restoreDefaultConfig(Palette.Program.BOTH_MODE)},passAttrstoProg:function(){for(var e,t=0;2>t;t++){e=t?this.attrs.fs:this.attrs.vs;for(var r in e.access){var n=e.send[r],s=e.access[r];if("mat"==s.type.substr(0,3))s.setFunction(s.pointer,this.context.FALSE,n);else if("vertexAttrib"==s.type){var a=this.attrs.vs.access[s.bufferName];s.setFunction(s,a)}else"buffer"==s.type?s.setFunction(s,n):s.setFunction(s.pointer,n)}}},setDrawMode:function(e){this.drawMode=e},generateSend:function(e,t){var r;for(var n in e.access)r=t[n]?t[n]:e.store[n],e.send[n]=r}},Palette.Program.fetchSetter=function(e,t){var r,n=function(e){return function(t,r){e(t,r[0])}},s=function(e){return function(t,r){e(t,r[0],r[1])}},a=function(e){return function(t,r){e(t,r[0],r[1],r[2])}},o=function(e){return function(t,r){e(t,r[0],r[1],r[2],r[3])}};switch(t){case"float":return n(e.uniform1f.bind(e));case"float[]":return e.uniform1fv.bind(e);case"int":return n(e.uniform1i.bind(e));case"int[]":return e.uniform1iv.bind(e);case"vec2":return s(e.uniform2f.bind(e));case"vec2[]":return e.uniform2fv.bind(e);case"ivec2":return s(e.uniform2i.bind(e));case"ivec2[]":return e.uniform2iv.bind(e);case"vec3":return a(e.uniform3f.bind(e));case"vec3[]":return e.uniform3fv.bind(e);case"ivec3":return a(e.uniform3i.bind(e));case"ivec3[]":return e.uniform3iv.bind(e);case"vec4":return o(e.uniform4f.bind(e));case"vec4[]":return e.uniform4fv.bind(e);case"ivec4":return o(e.uniform4i.bind(e));case"ivec4[]":return e.uniform4iv.bind(e);case"mat2":return e.uniformMatrix2fv.bind(e);case"mat3":return e.uniformMatrix3fv.bind(e);case"mat4":return e.uniformMatrix4fv.bind(e);case"texture":return alert("You're on your own, kid."),null;case"vertexAttrib":return r=function(t,r){e.bindBuffer(e.ARRAY_BUFFER,r.pointer),e.vertexAttribPointer(t.pointer,r.itemSize,e.FLOAT,!1,0,0)},r.bind(e);case"buffer":return r=function(t,r){e.bindBuffer(e.ARRAY_BUFFER,t.pointer),e.bufferData(e.ARRAY_BUFFER,r,e.DYNAMIC_DRAW)},r.bind(e);default:return alert("Not gonna lie - you really messed up. I can't pass "+t+" onto the shader."),null}},Palette.Program.NONE_MODE=0,Palette.Program.VS_MODE=1,Palette.Program.FS_MODE=2,Palette.Program.BOTH_MODE=3,Palette.Program.POINTS=0,Palette.Program.LINES=1,Palette.Program.LINE_LOOP=2,Palette.Program.LINE_STRIP=3,Palette.Program.TRIANGLES=4,Palette.Program.TRIANGLE_STRIP=5,Palette.Program.TRIANGLE_FAN=6,Palette.Program.POLYGON=7,Palette.Program.prototype.constructor=Palette.Program,Palette.Shader=function(e,t,r,n,s){this.name=t,this.type=r,this.context=e,this.attrs=s,this.shader=null,this.compiled=!1,this.bakeShader(n)},Palette.Shader.prototype={bakeShader:function(e){if(this.compiled)return null;switch(this.compiled=!0,this.type){case Palette.Shader.VS:this.shader=this.context.createShader(this.context.VERTEX_SHADER);break;case Palette.Shader.FS:this.shader=this.context.createShader(this.context.FRAGMENT_SHADER);break;default:return!1}return this.context.shaderSource(this.shader,e),this.context.compileShader(this.shader),this.context.getShaderParameter(this.shader,this.context.COMPILE_STATUS)?!0:(alert("An error occurred compiling the shaders: "+this.context.getShaderInfoLog(this.shader)),!1)}},Palette.Shader.VS=0,Palette.Shader.FS=1,Palette.Shader.LIST=2,Palette.Shader.prototype.constructor=Palette.Shader,Palette.ShaderFactory=function(e){this.that=this,this.manager=e,this.downloadInProgress=!1},Palette.ShaderFactory.prototype={addShader:function(e){var t,r;switch(this.establishType(e)){case Palette.ShaderFactory.SOURCE_OBJECT:t=e;case Palette.ShaderFactory.JSON:t=t||JSON.parse(e),r=this.createShaderObject(t);break;case Palette.ShaderFactory.SHADER_OBJECT:r=e;break;case Palette.ShaderFactory.URL:this.downloadFromURL(e);break;default:throw new Error("Not a valid type of shader.")}r&&this.registerShader(r)},createShaderObject:function(e){switch(e.type){case Palette.Shader.VS:case Palette.Shader.FS:return new Palette.Shader(this.manager.context,e.name,e.type,e.src,e.attrs);case Palette.Shader.LIST:for(var t=e.content.length-1;t>=0;t--)this.addShader(e.content[t]);break;default:throw new Error("Tried to create an illegal class of shader.")}},downloadFromURL:function(e){var t=new XMLHttpRequest;t.open("GET",e,!0),t.onload=function(){console.log(that),that.addShader(t.response),that.downloadInProgress=!1},that.downloadInProgress=!0,t.send()},establishType:function(e){var t=-1;return e instanceof Palette.Shader?t=Palette.ShaderFactory.SHADER_OBJECT:void 0!=e.type&&void 0!=e.name&&(e.content||e.src)?t=Palette.ShaderFactory.SOURCE_OBJECT:this.isJSON(e)?t=Palette.ShaderFactory.JSON:console.log("PALETTE: BAD SHADER. MALFORMED JSON OR BAD OBJECT SHAPE."),t},isJSON:function(e){try{return JSON.parse(e),!0}catch(t){return!1}},isString:function(e){return"string"==typeof e||e instanceof String},registerShader:function(e){switch(e.type){case Palette.Shader.VS:this.manager.vertShaders[e.name]=this.manager.vertShaders[e.name]||e;break;case Palette.Shader.FS:this.manager.fragShaders[e.name]=this.manager.fragShaders[e.name]||e;break;default:throw new Error("Tried to register an illegal class of shader.")}}},Palette.ShaderFactory.SOURCE_OBJECT=0,Palette.ShaderFactory.JSON=1,Palette.ShaderFactory.URL=2,Palette.ShaderFactory.SHADER_OBJECT=3,Palette.ShaderFactory.prototype.constructor=Palette.ShaderFactory,module.exports=earcut;